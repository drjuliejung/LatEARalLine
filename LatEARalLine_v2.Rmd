---
title: "LatEARalLine_v2"
author: "Julie Jung"
date: "July 5, 2019"
output: html_document
---

```{r setup, include=FALSE}
#rm(list=ls()) #clear environment
#setwd('/Users/juliejung/Desktop/GitHub/LatEARalLine') 
```

## install and load packages

```{r}
library(openxlsx);library(clinfun);library(car);library(MASS); library(multcomp);library(pscl);library(psych);library(lme4);library("stargazer");library("knitr");library("dplyr");library("tidyr");library(sciplot);library(ggplot2);library(ggrepel);library(extrafont); library(ggthemes);library(reshape);library(grid); library(scales);library(RColorBrewer);library(gridExtra);library(cowplot)
```

# Stimulus fig

Read in FFT data from raven. 
```{r}
#FFT.df<-read.csv("Fig3.csv", stringsAsFactors = TRUE)
#str(FFT.df)
```

```{r}
#max(FFT.df$Acceleration)
#88.86822 - 10 #78.86822
#88.86822 - 20 #68.86822
#88.86822 - 30 #58.86822
#88.86822 - 40 #48.86822

# Figure3a<-ggplot(data=FFT.df, aes(x=Frequencies, y=Acceleration)) + 
#   geom_line() +
#   scale_y_continuous(limits=c(45, 90),
#                      breaks=c(48.86822, 58.86822, 68.86822, 78.86822, 88.86822),
#                      labels=c("-40", "-30", "-20","-10", "0"))+
#   scale_x_continuous(limits=c(0, 225),
#                      breaks=c(0, 50, 100, 150, 200),
#                      labels=c("0", "50", "100", "150", "200"))+
#   labs(x = "\n Frequency (Hz)", 
#        y = "Relative amplitude (dB) \n") +
#   theme_cowplot(font_size = 12, line_size = 1) +
#   theme(axis.text.y=element_text(size=12, colour= "black")) +
#   theme(axis.text.x=element_text(size=12, colour= "black")) +
#   theme(axis.title.x=element_text(size=12, colour = "black")) +
#   theme(axis.title.y=element_text(size=12, colour = "black"))
# 
# Figure3a
```
```{r}
# Figure3b<-ggplot(data=FFT.df, aes(x=Frequencies, y=Acceleration)) + 
#   scale_y_continuous(limits=c(0, 1))+
#   scale_x_continuous(limits=c(0, 25),
#                      breaks=c(0, 5, 10, 15, 20, 25),
#                      labels=c("0", "5", "10", "15", "20", "25"))+
#   labs(x = "\n Time (s)", 
#        y = "Vibration amplitude \n") +
#   theme_cowplot(font_size = 12, line_size = 1) +
#   theme(axis.text.y=element_text(size=12, colour= "black")) +
#   theme(axis.text.x=element_text(size=12, colour= "black")) +
#   theme(axis.title.x=element_text(size=12, colour = "black")) +
#   theme(axis.title.y=element_text(size=12, colour = "black"))
# 
# Figure3b
```
```{r}
# Figure3c<-ggplot(data=FFT.df, aes(x=Frequencies, y=Acceleration)) + 
#   scale_y_continuous(limits=c(0, 1))+
#   scale_x_continuous(limits=c(0, 6),
#                      breaks=c(0, 1, 2, 3, 4, 5, 6),
#                      labels=c("0", "1", "2", "3", "4", "5", "6"))+
#   labs(x = "\n Time (min)", 
#        y = "Vibration amplitude \n") +
#   theme_cowplot(font_size = 12, line_size = 1) +
#   theme(axis.text.y=element_text(size=12, colour= "black")) +
#   theme(axis.text.x=element_text(size=12, colour= "black")) +
#   theme(axis.title.x=element_text(size=12, colour = "black")) +
#   theme(axis.title.y=element_text(size=12, colour = "black"))
# 
# Figure3c
```

combine plots 
```{r}
# Load required package
#require(gridExtra)

#Figure3 <- plot_grid(Figure3a, Figure3b, Figure3c, labels = "AUTO", heights = c(2, 1, 1), ncol = 1, nrow=3, align = 'v')

# ggsave("~/Desktop/Figure3.pdf", 
#  plot = Figure3a, # or give ggplot object name as in myPlot,
#  width = 20, height = 10, 
#  units = "cm", # other options c("in", "cm", "mm"), 
#  dpi = 300)
# dev.off()

```

# ONTOGENY OF LL USING DIASP DATA

Data collected 2018 for a pilot study on visualizing lateral line neuromasts with Diasp. 

Compare number of neuromasts between younger (age 2d and 3d) and older (age 4d and 5d) aged groups

Read in Diasp spreadsheet
```{r}
Diasp.df<-read.csv("diaspV10.csv", stringsAsFactors = TRUE)
str(Diasp.df)
```

Convert the hours, mins, second columns into useable time data. 
Make a column for individual age (based on time jiggled)
```{r}
Diasp.df$Stimulus_start_age <- Diasp.df$AgeDays + Diasp.df$JiggledHour/24 + Diasp.df$JiggledMin/(24*60) + Diasp.df$JiggledSec/(24*60*60) # Stimulus_start_age is in days
Diasp.df$Stimulus_start <- Diasp.df$JiggledHour*60 + Diasp.df$JiggledMin + Diasp.df$JiggledSec/60 # Stimulus_start is in minutes
Diasp.df$Hatch_time <- Diasp.df$HatchedHour*60 + Diasp.df$HatchedMin + Diasp.df$HatchedSec/60 #Hatch time is also in minutes

Diasp.df$Latency_min <- Diasp.df$Hatch_time - Diasp.df$Stimulus_start
```

If Latency_min is 0, replace with 1 second. 
```{r}
ordered<-Diasp.df[order(Diasp.df$Latency_min),]

Diasp.df$Latency_min[Diasp.df$Latency_min==0]<-1/60

ordered<-Diasp.df[order(Diasp.df$Latency_min),] #check to see they're changed. 
```

```{r}
min(Diasp.df$Date)
max(Diasp.df$Date)
```

```{r}
Diasp.df$JJ_revised_total <- Diasp.df$JJ_face_middle_totalsides +
  Diasp.df$JJ_face_yolk_totalsides +
  Diasp.df$JJ_face_mouth_totalsides +
  Diasp.df$JJ_face_undereye_totalsides +
  (Diasp.df$JJ_body_ALL_1side)*2 +
  (Diasp.df$JJ_body_PLL_1side)*2 +
  Diasp.df$JJ_body_dorsal_totalsides

Diasp.df$AC_revised_total <- Diasp.df$AC_face_middle_totalsides +
  Diasp.df$AC_face_yolk_totalsides +
  Diasp.df$AC_face_mouth_totalsides +
  Diasp.df$AC_face_undereye_totalsides +
  (Diasp.df$AC_body_ALL_1side)*2 +
  (Diasp.df$AC_body_PLL_1side)*2 +
  Diasp.df$AC_body_dorsal_totalsides
```

Take the average of my counts and Avital's counts. 
```{r}
Diasp.df$JJAC_total <- (Diasp.df$JJ_revised_total + Diasp.df$AC_revised_total)/2
Diasp.df$JJAC_total_excel <- (Diasp.df$JJ_total + Diasp.df$AC_total)/2

Diasp.df$Difference <- Diasp.df$JJAC_total - Diasp.df$JJAC_total_excel
```

split up younger (age 2d and 3d) and older (age 4d and 5d) aged groups
```{r}
#younger <- subset(Diasp.df, Diasp.df$AgeDays<4, na.rm=T)
#older <- subset(Diasp.df, Diasp.df$AgeDays>3, na.rm=T) 
```

```{r}
all_clutch<-
  Diasp.df %>%
  group_by(Clutch) %>%
  summarize(count = n(),
            mean = mean(JJAC_total, na.rm=T),
            SD = sd(JJAC_total, na.rm=T), 
            SE = sd(JJAC_total, na.rm=T)/sqrt(n())
            )

kable(all_clutch,title="Mean & SD & SE",digits=4)

sum(all_clutch$count) #79 total tads
```

##### STATS

```{r}
hist(Diasp.df$JJAC_total)
hist(log(Diasp.df$JJAC_total)) #seems not normal...

shapiro.test(Diasp.df$JJAC_total)#not normal #should use non parametric
shapiro.test(log(Diasp.df$JJAC_total+1))
```

If p-value > 0.05 that implies that the distribution of the data are not significantly different from normal distribution. In other words, we can assume the normality. 

If p<0.05, not normal. 

```{r}
Diasp.df$JJAC_total_count<-ceiling(Diasp.df$JJAC_total)

fit1<-fitdistr(Diasp.df$JJAC_total, "normal")
fit2<-fitdistr(Diasp.df$JJAC_total, "cauchy") 
fit3<-fitdistr(Diasp.df$JJAC_total+1, "lognormal")#must be positive
fit4<-fitdistr(Diasp.df$JJAC_total_count, "Poisson") ##must be count/integers
fit5<-fitdistr(Diasp.df$JJAC_total_count, "negative binomial") ##must be count/integers
#fit4<-fitdistr(ceiling(Diasp.df$JJAC_total)+1, "Gamma") #must be >=0
#fit5<-fitdistr(Diasp.df$JJAC_total, "weibull")
#fit8<-fitdistr(Diasp.df$JJAC_total, "beta") #must be between 0 and 1, beta means 0 heavy
#fit9<-fitdistr(Diasp.df$JJAC_total, "Binomial") #must be between 0 and 1

AIC(fit1,fit2, fit3, fit4, fit5) # best to do negative binomial

```

```{r}
glm.negb1 <- glm.nb(JJAC_total_count ~ 1 + (1|Clutch), data=Diasp.df)
glm.negb2 <- glm.nb(JJAC_total_count ~ Final_Stages + (1|Clutch), data=Diasp.df)
glm.negb3 <- glm.nb(JJAC_total_count ~ Stimulus_start_age + (1|Clutch), data=Diasp.df)
glm.negb4 <- glm.nb(JJAC_total_count ~ Tadpole_length + (1|Clutch), data=Diasp.df)
glm.negb5 <- glm.nb(JJAC_total_count ~ Final_Stages + Stimulus_start_age + Tadpole_length + (1|Clutch), data=Diasp.df)

anova(glm.negb1, glm.negb2)# strong stage effect
Anova(glm.negb2) #reported
anova(glm.negb1, glm.negb3)# strong age effect
Anova(glm.negb3) #reported
anova(glm.negb1, glm.negb4)# strong tadpole length effect
Anova(glm.negb4) #reported

AIC(glm.negb1)
AIC(glm.negb2)
AIC(glm.negb3)
AIC(glm.negb4)
AIC(glm.negb5) #best model

Anova(glm.negb5) #only stage is significant #reported
```

Post hoc tests

```{r}
# Diasp.df$Final_Stages<-as.factor(Diasp.df$Final_Stages)
# 
# lmer3<-lmer(JJAC_total ~ Final_Stages + (1|Clutch), data=Diasp.df)
# lm4<-glht(lmer3, linfct=mcp(Final_Stages = "Tukey"))
# summary(lm4)
# cld(lm4) 
# 
# 
# lmer3<-lmer(JJAC_total ~ Final_Stages + Stimulus_start_age + Tadpole_length + (1|Clutch), data=Diasp.df)
# lm4<-glht(lmer3, linfct=mcp(Final_Stages = "Tukey"))
# summary(lm4)
# cld(lm4) 

# glm.negb2 <- glm.nb(JJAC_total_count ~ Final_Stages + (1|Clutch), data=Diasp.df)
# lm5<-glht(glm.negb2, linfct=mcp(Final_Stages="Tukey"))
# summary(lm5)
# cld(lm5) 
```

##### figure

Using the whole dataset, graph the total # of neuromasts by stage:

```{r}
all_stage<-
  Diasp.df %>%
  group_by(Final_Stages) %>%
  summarize(count = n(),
            mean = mean(JJAC_total, na.rm=T),
            SD = sd(JJAC_total, na.rm=T), 
            SE = sd(JJAC_total, na.rm=T)/sqrt(n())
            )

kable(all_stage,title="Mean & SD & SE",digits=4)

sum(all_stage$count) #79 total tads

quantile(Diasp.df$JJAC_total)
mean(Diasp.df$JJAC_total)
se(Diasp.df$JJAC_total)

#only stages 29, 31, 32
Diasp.df$Final_Stages <- as.numeric(Diasp.df$Final_Stages)
Diasp.df$Final_Stages
olderones<-subset(Diasp.df, Final_Stages>4, na.rm=TRUE)
quantile(olderones$JJAC_total, na.rm=T)
mean(olderones$JJAC_total)
se(olderones$JJAC_total)
```
plot of neuromasts x stage, with hatching response separated by color
```{r}
ggplot(Diasp.df, aes(x=Final_Stages, y=JJAC_total, color=HorNH)) + 
  geom_point(size=3) +
  ylab("Neuromasts")+
  theme(panel.grid.major = element_blank(),
      panel.grid.minor = element_blank())+
  xlab("Developmental stage")+
  theme(legend.position="none") +
  theme_cowplot(font_size = 18, line_size = 1) +
  theme(axis.text.y=element_text(size=18, colour= "black")) +
  theme(axis.text.x=element_text(size=18, colour= "black")) +
  theme(axis.title.x=element_text(size=18, colour = "black")) +
  theme(axis.title.y=element_text(size=18, colour = "black"))
```

```{r}
str(Diasp.df)
#Diasp.df$Final_Stages<-as.factor(as.character(Diasp.df$Final_Stages))
#Diasp.df$HorNH<-as.factor(as.character(Diasp.df$HorNH))

Hat<-subset(Diasp.df, Diasp.df$HorNH=="Yes", na.rm=TRUE)
NoHat<-subset(Diasp.df, Diasp.df$HorNH=="No", na.rm=TRUE)
```

Tad length figure 
```{r}
Figure4a<-ggplot(data=Diasp.df, aes(x=Tadpole_length, y=JJAC_total, group=HorNH)) + 
  geom_jitter(data=NoHat, pch=19, size=2, position=position_jitter(width=0.25)) +
  geom_jitter(data=Hat, pch=1, size=2,  position=position_jitter(width=0.25)) +
  scale_y_continuous(limits=c(0, 450),
                     breaks=c(0, 100, 200, 300, 400),
                     labels=c("0", "100", "200", "300", "400"))+
  scale_x_continuous(limits=c(6, 12),
                     breaks=c(6, 8, 10, 12),
                     labels=c("6", "8", "10", "12"))+
  scale_shape_manual(name=NULL, 
                     values=c(19, 1),
                     labels=c("No hatch", "Hatch")) +
  labs(x = "Tadpole length (mm)", 
       y = "# of neuromasts") +
  theme_cowplot(font_size = 12, line_size = 1) +
  theme(axis.text.y=element_text(size=12, colour= "black")) +
  theme(axis.text.x=element_text(size=12, colour= "black")) +
  theme(axis.title.x=element_text(size=12, colour = "black")) +
  theme(axis.title.y=element_text(size=12, colour = "black"))

Figure4a
```


Age figure 
```{r}
Figure4b<-ggplot(data=Diasp.df, aes(x=Stimulus_start_age, y=JJAC_total, group=HorNH)) + 
  geom_jitter(data=NoHat, pch=19, size=2, position=position_jitter(width=0.25)) +
  geom_jitter(data=Hat, pch=1, size=2,  position=position_jitter(width=0.25)) +
  scale_y_continuous(limits=c(0, 450),
                     breaks=c(0, 100, 200, 300, 400),
                     labels=c("0", "100", "200", "300", "400"))+
  scale_x_continuous(limits=c(3, 5.5),
                     breaks=c(3, 3.5, 4, 4.5, 5, 5.5),
                     labels=c("3", "3.5", "4", "4.5", "5", "5.5"))+
  scale_shape_manual(name=NULL, 
                     values=c(19, 1),
                     labels=c("No hatch", "Hatch")) +
  labs(x = "Age (d)", 
       y = "# of neuromasts") +
  theme_cowplot(font_size = 12, line_size = 1) +
  theme(axis.text.y=element_text(size=12, colour= "black")) +
  theme(axis.text.x=element_text(size=12, colour= "black")) +
  theme(axis.title.x=element_text(size=12, colour = "black")) +
  theme(axis.title.y=element_text(size=12, colour = "black"))

Figure4b
```

```{r}
Figure4c<-ggplot(data=Diasp.df, aes(x=Final_Stages, y=JJAC_total, group=HorNH)) + 
  geom_jitter(data=NoHat, pch=19, size=2, position=position_jitter(width=0.25)) +
  geom_jitter(data=Hat, pch=1, size=2,  position=position_jitter(width=0.25)) +
  scale_y_continuous(limits=c(0, 450),
                     breaks=c(0, 100, 200, 300, 400),
                     labels=c("0", "100", "200", "300", "400"))+
  scale_x_continuous(limits=c(25, 32.3),
                     breaks=c(25, 26, 27, 28, 29, 30, 31, 32),
                     labels=c("25", "26", "27", "28", "29", "30", "31", "32"))+
  scale_shape_manual(name=NULL, 
                     values=c(19, 1),
                     labels=c("No hatch", "Hatch")) +
  labs(x = "Developmental stage", 
       y = "# of neuromasts") +
  theme_cowplot(font_size = 12, line_size = 1) +
  theme(axis.text.y=element_text(size=12, colour= "black")) +
  theme(axis.text.x=element_text(size=12, colour= "black")) +
  theme(axis.title.x=element_text(size=12, colour = "black")) +
  theme(axis.title.y=element_text(size=12, colour = "black"))

Figure4c
```

combine plots 
```{r}
FigureS1 <- plot_grid(Figure4a, Figure4b, Figure4c, labels = "AUTO", ncol = 1, align = 'v')

ggsave("~/Desktop/FigureS1.pdf",
 plot = FigureS1, # or give ggplot object name as in myPlot,
 width = 10, height = 20,
 units = "cm", # other options c("in", "cm", "mm"),
 dpi = 300,
 useDingbats=FALSE)

```

Let's just look at the face now. Does # neuromasts on the face predict H or NH?

```{r}
# ggplot(Diasp.df, aes(x=Final_Stages, y=JJ_body_dorsal_totalsides, color=HorNH)) + 
#   geom_point(size=3) +
#   ylab("Neuromasts")+
#   theme_bw(20) +
#   theme(panel.grid.major = element_blank(),
#       panel.grid.minor = element_blank())+
#   xlab("Developmental stage")+
#   theme(legend.position="none")
```

What you DON’T have here, that you set up earlier, is how does this # neuromasts relate to MCH response – Can you address that? Looks like below some # of neuromasts there was no hatching, then above they might hatch or not. Maybe do a binomial curve fit (hatched or not) w/ #neuromasts as the predictor, like you did for VOR amplitude?
You could add that as a panel and drop the age & length panels (or move to supp. fig.?)

Moreover, developmental stage and VOR amplitude were significant predictors of hatching (Fig. 8a, binomial GLMM for Response ~ Stage + VOR with Clutch as a random effect). 

```{r}
#replace no and yes with 0 and 1
Diasp.df<-Diasp.df %>%
  mutate(HorNH = ifelse(HorNH == "No", 0, 1))
```

```{r}
NH_s25 <-subset(Diasp.df, Diasp.df$HorNH==0 & Final_Stages==25)
NH_s26 <-subset(Diasp.df, Diasp.df$HorNH==0 & Final_Stages==26)
NH_s27 <-subset(Diasp.df, Diasp.df$HorNH==0 & Final_Stages==27)
NH_s28 <-subset(Diasp.df, Diasp.df$HorNH==0 & Final_Stages==28)
H_s28  <-subset(Diasp.df, Diasp.df$HorNH==1 & Final_Stages==28)
NH_s29 <-subset(Diasp.df, Diasp.df$HorNH==0 & Final_Stages==29)
H_s29  <-subset(Diasp.df, Diasp.df$HorNH==1 & Final_Stages==29)
H_s31  <-subset(Diasp.df, Diasp.df$HorNH==1 & Final_Stages==31)
H_s32  <-subset(Diasp.df, Diasp.df$HorNH==1 & Final_Stages==32)
```

```{r}
#stagecolors <- c("black", "brown2", "orange1", "sienna4", "limegreen", "forestgreen")
stagecolors <- brewer.pal("BrBG", n=11)

plot.stageGLM <- ggplot(Diasp.df, aes(x=as.numeric(as.character(Final_Stages)), y=as.numeric(as.character(HorNH)))) +
  stat_smooth(method = "glm", method.args=list(family="binomial"), color="black", linetype="dashed") +
  geom_point(data=NH_s25, aes(x=as.numeric(as.character(Final_Stages)), fill=stagecolors[1]), colour="black", pch=21, size=4, position=position_jitter(height=0.06, width=0.2)) +
  geom_point(data=NH_s26, aes(x=as.numeric(as.character(Final_Stages)), fill=stagecolors[2]), colour="black", pch=21, size=4, position=position_jitter(height=0.06, width=0.2)) +
  geom_point(data=NH_s27, aes(x=as.numeric(as.character(Final_Stages)), fill=stagecolors[3]), colour="black", pch=21, size=4, position=position_jitter(height=0.06, width=0.2)) +
  geom_point(data=NH_s28, aes(x=as.numeric(as.character(Final_Stages)), fill=stagecolors[4]), colour="black", pch=21, size=4, position=position_jitter(height=0.06, width=0.2)) +
  geom_point(data=H_s28, aes(x=as.numeric(as.character(Final_Stages)), fill=stagecolors[4]), colour="black", pch=21, size=4, position=position_jitter(height=0.06, width=0.2)) +
  geom_point(data=NH_s29, aes(x=as.numeric(as.character(Final_Stages)), fill=stagecolors[5]), colour="black", pch=21, size=4, position=position_jitter(height=0.06, width=0.2)) +
  geom_point(data=H_s29, aes(x=as.numeric(as.character(Final_Stages)), fill=stagecolors[5]), colour="black", pch=21, size=4, position=position_jitter(height=0.06, width=0.2)) +
  geom_point(data=H_s31, aes(x=as.numeric(as.character(Final_Stages)), fill=stagecolors[6]), colour="black", pch=21, size=4, position=position_jitter(height=0.06, width=0.2)) +
  geom_point(data=H_s32, aes(x=as.numeric(as.character(Final_Stages)), fill=stagecolors[7]), colour="black", pch=21, size=4, position=position_jitter(height=0.06, width=0.2)) +
    scale_fill_identity(name="Stage", 
                       breaks=c(stagecolors[1], stagecolors[2], stagecolors[3], stagecolors[4], stagecolors[5], stagecolors[6], stagecolors[7]),
                       labels=c(25, 26, 27, 28, 29, 31, 32), 
                       guide="legend") +
  theme(legend.background = element_rect(fill="white",
                                  size=0.75, linetype="solid", 
                                  colour ="black")) + 
  scale_y_continuous(breaks = c(0, 1))+
  theme(axis.text.y=element_text(size=14, colour= "black")) +
  theme(axis.text.x=element_text(size=14, colour= "black")) +
  theme(axis.title.x=element_text(size=14, colour = "black")) +
  theme(axis.title.y=element_text(size=14, colour = "black"))+
  labs(y = "Hatching response \n", 
       x = "\n Developmental stage")+
  theme_cowplot(font_size = 14, line_size = 1)+
    theme(legend.justification = c(0, 1), legend.position = c(0.05,1))

plot.stageGLM
```

```{r}
show_col(stagecolors)
plot.LL.GLM <- ggplot(Diasp.df, aes(x=as.numeric(as.character(JJAC_total)), y=as.numeric(as.character(HorNH)))) +
  stat_smooth(method = "glm", method.args=list(family="binomial"), color="black", linetype="dashed") +
  geom_point(data=NH_s25, aes(x=as.numeric(as.character(JJAC_total)), fill=stagecolors[1]), colour="black", pch=21, size=2, position=position_jitter(height=0.06)) +
  geom_point(data=NH_s26, aes(x=as.numeric(as.character(JJAC_total)), fill=stagecolors[3]), colour="black", pch=21, size=2, position=position_jitter(height=0.06)) +
  geom_point(data=NH_s27, aes(x=as.numeric(as.character(JJAC_total)), fill=stagecolors[5]), colour="black", pch=21, size=2, position=position_jitter(height=0.06)) +
  geom_point(data=NH_s28, aes(x=as.numeric(as.character(JJAC_total)), fill=stagecolors[7]), colour="black", pch=21, size=2, position=position_jitter(height=0.06)) +
  geom_point(data=H_s28, aes(x=as.numeric(as.character(JJAC_total)), fill=stagecolors[7]), colour="black", pch=21, size=2, position=position_jitter(height=0.06)) +
  geom_point(data=NH_s29, aes(x=as.numeric(as.character(JJAC_total)), fill=stagecolors[9]), colour="black", pch=21, size=2, position=position_jitter(height=0.06)) +
  geom_point(data=H_s29, aes(x=as.numeric(as.character(JJAC_total)), fill=stagecolors[9]), colour="black", pch=21, size=2, position=position_jitter(height=0.06)) +
  geom_point(data=H_s31, aes(x=as.numeric(as.character(JJAC_total)), fill=stagecolors[10]), colour="black", pch=21, size=2, position=position_jitter(height=0.06)) +
  geom_point(data=H_s32, aes(x=as.numeric(as.character(JJAC_total)), fill=stagecolors[11]), colour="black", pch=21, size=2, position=position_jitter(height=0.06)) +
    scale_fill_identity(name="Stage", 
                       breaks=c(stagecolors[1], stagecolors[3], stagecolors[5], stagecolors[7], stagecolors[9], stagecolors[10], stagecolors[11]),
                       labels=c(25, 26, 27, 28, 29, 31, 32), 
                       guide="legend") +
  theme(legend.background = element_rect(fill="white",
                                  size=0.75, linetype="solid", 
                                  colour ="black")) + 
  scale_y_continuous(breaks = c(0, 1))+
  theme(axis.text.y=element_text(size=12, colour= "black")) +
  theme(axis.text.x=element_text(size=12, colour= "black")) +
  theme(axis.title.x=element_text(size=12, colour = "black")) +
  theme(axis.title.y=element_text(size=12, colour = "black"))+
  labs(y = "Hatching response", 
       x = "Number of neuromasts")+
  theme_cowplot(font_size = 12, line_size = 1)+
  theme(legend.justification = c(0, 1), legend.position = c(0.05,1))

plot.LL.GLM
```


```{r}
ggsave("~/Desktop/Figure4v3.pdf",
 plot = plot.LL.GLM, # or give ggplot object name as in myPlot,
 width = 15, height = 10,
 units = "cm", # other options c("in", "cm", "mm"),
 dpi = 300)
```

combine plots 
```{r}
Figure4v2 <- plot_grid(Figure4c, plot.LL.GLM, labels = "AUTO", ncol = 1, align = 'v')

ggsave("~/Desktop/Figure4v2.pdf",
 plot = Figure4v2, # or give ggplot object name as in myPlot,
 width = 20, height = 20,
 units = "cm", # other options c("in", "cm", "mm"),
 dpi = 300, 
 useDingbats=FALSE)

```

```{r}
glmm1 <- glmer(HorNH ~ Final_Stages + (1|Clutch), family=binomial(logit), data=Diasp.df)
glmm2 <- glmer(HorNH ~ JJAC_total + (1|Clutch), family=binomial(logit), data=Diasp.df)
glmm3 <- glmer(HorNH ~ JJAC_total + Final_Stages + (1|Clutch), family=binomial(logit), data=Diasp.df)
glmm4 <- glmer(HorNH ~ JJAC_total * Final_Stages + (1|Clutch), family=binomial(logit), data=Diasp.df)

summary(glmm1)
summary(glmm2)
summary(glmm3)
summary(glmm4)

AIC(glmm1)
AIC(glmm2)
AIC(glmm3)
AIC(glmm4)

anova(glmm1,glmm3) # LL effect
anova(glmm2,glmm3) # stage effect
anova(glmm3,glmm4) #interaction

Anova(glmm4) ####### all the effects. 
```

## Read in all data
```{r} 
all_data<-read.csv("20200207_LatEARalLine.csv", header=TRUE, stringsAsFactors = FALSE)
```

```{r}
all_data$Mean_VOR<-(all_data$Amplitude_left+all_data$Amplitude_right)/2

jiggling.df <- subset(all_data, Experiment=="Individual")
playback.df <- subset(all_data, Experiment=="Tray")
```

# INDIVIDUAL DATA

Subset jiggling data only

```{r}
#jiggling.df <- subset(all_data, Experiment=="Individual")
```

Convert the hours, mins, second columns into useable time data. 

```{r}
#jiggling.df$Hatch_h<-as.numeric(as.character(jiggling.df$Hatch_h))
#jiggling.df$Hatch_m<-as.numeric(as.character(jiggling.df$Hatch_m))
#jiggling.df$Hatch_s<-as.numeric(as.character(jiggling.df$Hatch_s))

jiggling.df$Average_amplitude <- (jiggling.df$Amplitude_right + jiggling.df$Amplitude_left)/2
jiggling.df$Stimulus_start_age <- jiggling.df$Age_days + jiggling.df$Stimulus_h/24 + jiggling.df$Stimulus_m/(24*60) + jiggling.df$Stimulus_s/(24*60*60) # Stimulus_start_age is in days
jiggling.df$Stimulus_start <- jiggling.df$Stimulus_h*60 + jiggling.df$Stimulus_m + jiggling.df$Stimulus_s/60 # Stimulus_start is in minutes
jiggling.df$Hatch_time <- jiggling.df$Hatch_h*60 + jiggling.df$Hatch_m + jiggling.df$Hatch_s/60 #Hatch time is also in minutes

jiggling.df$Latency_min <- jiggling.df$Hatch_time - jiggling.df$Stimulus_start
```

Subtract 15 seconds (0.25 min) from the latencies of just the G treated individuals because we always started jiggling the G treated ones 15 seconds after jiggling the NT individuals. 

```{r}
all_G <- subset(jiggling.df, jiggling.df$Treatment=="G")
all_NT <- subset(jiggling.df, jiggling.df$Treatment=="NT")

all_G$Latency_min<-all_G$Latency_min-0.25

jiggling.df<-rbind(all_G, all_NT)

#ordered<-jiggling.df[order(jiggling.df$Latency_min),]
```

If Latency_min is 0, replace with 1 second. 

```{r}
ordered<-jiggling.df[order(jiggling.df$Latency_min),]

jiggling.df$Latency_min[jiggling.df$Latency_min==0]<-1/60

ordered<-jiggling.df[order(jiggling.df$Latency_min),] #check to see they're changed. 
```

Organize data by clutch

```{r}
All_by_clutch<-
  jiggling.df %>%
  group_by(Clutch, Treatment) %>%
  summarize(num_tested = n(),
            num_hatched = sum(Response),
            propH = mean(sum(Response)/n())
            )
kable(All_by_clutch,digits=4)

nrow(jiggling.df) #1212 individuals/rows in jiggling.df
```

Subset out clutches where we tested fewer than 5 individuals per treatment
```{r}
jiggling.df <- subset(jiggling.df, jiggling.df$Clutch!=102 & jiggling.df$Clutch!=153)
```

How individuals from how many clutches did we jiggle? And from what dates?
```{r}
nrow(jiggling.df)#1202 individuals/rows in jiggling.df now

All_by_clutch<-
  jiggling.df %>%
  group_by(Clutch) %>%
  summarize(num_tested = n(),
            num_hatched = sum(Response),
            propH = mean(sum(Response)/n())
            )
kable(All_by_clutch,digits=4) 
nrow(All_by_clutch)#60 clutches

All_by_clutch_and_treatment<-
  jiggling.df %>%
  group_by(Clutch, Treatment) %>%
  summarize(num_tested = n(),
            num_hatched = sum(Response),
            propH = mean(sum(Response)/n())
            )
kable(All_by_clutch_and_treatment,digits=4)
```

```{r}
min(jiggling.df$Date)
max(jiggling.df$Date)
```

What are the mean and SE dates per age group (young, mid, old)?

```{r}
Jiggling_by_age_groups_3<-
  jiggling.df %>%
  group_by(Age_groups_three) %>%
  summarize(num_tested = n(),
            mean_stim_start_age = mean(Stimulus_start_age),
            SD = sd(Stimulus_start_age),
            SE = sd(Stimulus_start_age)/sqrt(n())
            )
kable(Jiggling_by_age_groups_3,digits=4)
```

What are the mean and SE stages per age group (young, mid, old)?

```{r}
Jiggling_by_stage<-
  jiggling.df %>%
  group_by(Age_groups_three) %>%
  summarize(num_tested = n(),
            mean_stage = mean(Jiggling_stage, na.rm=T),
            SD = sd(Jiggling_stage, na.rm=T),
            SE = sd(Jiggling_stage, na.rm=T)/sqrt(n())
            )
kable(Jiggling_by_stage,digits=4)
```
What are the mean and SE dates per age group when we split into 4 age groups (young <10 VOR, young >10 VOR, mid, old)?

```{r}
Jiggling_by_age_groups_4<-
  jiggling.df %>%
  group_by(Age_groups_four) %>%
  summarize(num_tested = n(),
            mean_stim_start_age = mean(Stimulus_start_age),
            SD = sd(Stimulus_start_age),
            SE = sd(Stimulus_start_age)/sqrt(n()), 
            min = min(Stimulus_start_age), 
            max = max(Stimulus_start_age)
            )
kable(Jiggling_by_age_groups_4,digits=4)
```

What are the mean and SE stages per age group when we split into 4 age groups (young <10 VOR, young >10 VOR, mid, old)?

```{r}
Jiggling_by_stage<-
  jiggling.df %>%
  group_by(Age_groups_four) %>%
  summarize(num_tested = n(),
            mean_stage = mean(Jiggling_stage, na.rm=T),
            SD = sd(Jiggling_stage, na.rm=T),
            SE = sd(Jiggling_stage, na.rm=T)/sqrt(n()), 
            min = min(Jiggling_stage, na.rm=T), 
            max = max(Jiggling_stage, na.rm=T)
            )
kable(Jiggling_by_stage,digits=4)
```



How often did we measure VOR? 
```{r}
VOR_stats <-
  jiggling.df %>%
  filter(!is.na(Sample_name)) %>%
  group_by(Age_groups_four) %>%
  summarize(num_tested = n(),
            meanVOR = mean(Average_amplitude),
            SD = sd(Average_amplitude),
            SE = sd(Average_amplitude)/sqrt(n())
            )

kable(VOR_stats,digits=4)

79+32
```
Did we only measure VOR for those that hatching to jiggling cues? No, but almost. 
```{r}
VOR_Response_stats <-
  jiggling.df %>%
  filter(!is.na(Sample_name)) %>%
  group_by(Response, Age_groups_four) %>%
  summarize(num_tested = n(),
            meanVOR = mean(Average_amplitude),
            SD = sd(Average_amplitude),
            SE = sd(Average_amplitude)/sqrt(n())
            )

kable(VOR_Response_stats,digits=4)
```

How often did we check for LL blockage?
```{r}
LL_stats <-
  jiggling.df %>%
  filter(!is.na(LL1start)) %>%
  group_by(Age_groups_four) %>%
  summarize(num_tested = n())

kable(LL_stats,digits=4)

sum(LL_stats$num_tested)
```

Separate the four different age groups

```{r}
younger_jiggling_low <- subset(jiggling.df, jiggling.df$Age_groups_four=="4d_lowVOR")
younger_jiggling_high <- subset(jiggling.df, jiggling.df$Age_groups_four=="4d_highVOR")
younger_jiggling <- subset(jiggling.df, jiggling.df$Age_groups_three=="young")
middle_jiggling <- subset(jiggling.df, jiggling.df$Age_groups_four=="4d")
older_jiggling <- subset(jiggling.df, jiggling.df$Age_groups_four=="5d")
```

Check that we checked lateral line for all the younger age group individuals that DID hatch and WERE treated (N=3). 

```{r}
younger_jiggling %>%
  filter(!is.na(LL1start)) %>%
  select(Sample_name, Treatment, Response, LL1start, LL1end, Jiggling_stage)

younger_jiggling %>%
  filter(Response==1 & Treatment == "G") %>%
  select(Sample_name, Treatment, Response, LL1start, LL1end, Jiggling_stage)
```

Compare the younger_low (without VOR) and younger_high (with VOR) groups: 
Are they significantly different in age or stage? Probably not... 
Next adjust ontogeny figure accordingly. 

We'll use mann-whitney-wilcoxon test because our 2 data samples (younger and older) are independent/come from distinct populations, so the samples do not affect each other. 

Also because our data are non-parametric. 

```{r, warning=FALSE}
wtest<-wilcox.test(younger_jiggling$Jiggling_stage ~ younger_jiggling$Age_groups_four, mu = 0, alt="two.sided", paired = F, conf.int=T, conf.level=0.95)
qnorm(wtest$p.value) #z-value to report
wtest

wtest<-wilcox.test(younger_jiggling$Stimulus_start_age ~ younger_jiggling$Age_groups_four, mu = 0, alt="two.sided", paired = F, conf.int=T, conf.level=0.95)
qnorm(wtest$p.value) #z-value to report
wtest
```

Plot the difference in stage between no VOR and VOR groups

```{r}
stage_by_VOR <- ggplot(younger_jiggling, aes(x=Age_groups_four, y=Jiggling_stage)) +
    geom_boxplot(outlier.shape = NA)+
    geom_jitter(colour="black", pch=16, size=2, position=position_jitter(width=0.1)) +
  #scale_y_continuous(limits=c(26, 29),
  #                   breaks=c(27, 28),
  #                   labels=c("27","28"))+
  scale_x_discrete(labels=c("WITH VOR", "NO VOR")) +
  xlab(NULL)+
  ylab("Stage")+ 
  theme_cowplot(font_size = 8, line_size = 1, font_family="Helvetica")+
  theme(axis.text.y=element_text(size=8, colour= "black")) +
  theme(axis.text.x=element_text(size=8, colour= "black")) +
  theme(axis.title.x=element_text(size=8, colour = "black")) +
  theme(axis.title.y=element_text(size=8, colour = "black")) +
  theme(legend.position = "none")

stage_by_VOR
```

Plot the difference in age between no VOR and VOR groups

```{r}
age_by_VOR <- ggplot(younger_jiggling, aes(x=Age_groups_four, y=Stimulus_start_age)) +
    geom_boxplot(outlier.shape = NA)+
    geom_jitter(colour="black", pch=16, size=2, position=position_jitter(width=0.1)) +
  #scale_y_continuous(limits=c(26, 29),
  #                   breaks=c(27, 28),
  #                   labels=c("27","28"))+
  scale_x_discrete(labels=c("WITH VOR", "NO VOR")) +
  xlab(NULL)+
  ylab("Age (d)")+ 
  theme_cowplot(font_size = 8, line_size = 1, font_family="Helvetica")+
  theme(axis.text.y=element_text(size=8, colour= "black")) +
  theme(axis.text.x=element_text(size=8, colour= "black")) +
  theme(axis.title.x=element_text(size=8, colour = "black")) +
  theme(axis.title.y=element_text(size=8, colour = "black")) +
  theme(legend.position = "none")

age_by_VOR
```

Estimate misclassification rate. 

In the younger jiggling dataset, we have some indivs classified as VOR + and some VOR -. 
Are there any classified as VOR + that actually have VOR <10? YES 5 / 54 positives
Are there any classified as VOR - that actually have VOR >10? NO

```{r}
younger_measured_VOR <- younger_jiggling %>%
  filter(!is.na(Sample_name)) %>%
  select(Clutch, Age_groups_four, Average_amplitude, VOR_Too_High)
```

##Proportion Hatched

### younger low age group

```{r}
Younger_low_by_clutch<-
  younger_jiggling_low %>%
  group_by(Clutch, Treatment) %>%
  summarize(num_tested = n(),
            num_hatched = sum(Response),
            propH = mean(sum(Response)/n())
            )
kable(Younger_low_by_clutch,digits=4)
```
The proportion hatched here is per treatment, per clutch. 

```{r}
Younger_low_clutch_means<-
  Younger_low_by_clutch %>%
  group_by(Treatment) %>%
  summarize(num_clutches = n(),
            mean_propH = mean(propH),
            SD = sd(propH),
            SE = sd(propH)/sqrt(n())
            )
Younger_low_clutch_means$AgeGroup <- 4.17
kable(Younger_low_clutch_means,digits=4)
```
25 pairs (taking out the ones with above threshold VOR)
28 pairs (without taking out the ones with above threshold VOR)
The SE here is among clutches (per treatment). 

### younger high age group

```{r}
Younger_high_by_clutch<-
  younger_jiggling_high %>%
  group_by(Clutch, Treatment) %>%
  summarize(num_tested = n(),
            num_hatched = sum(Response),
            propH = mean(sum(Response)/n())
            )
kable(Younger_high_by_clutch,digits=4)
```

The proportion hatched here is per treatment, per clutch. 

```{r}
Younger_high_clutch_means<-
  Younger_high_by_clutch %>%
  group_by(Treatment) %>%
  summarize(num_clutches = n(),
            mean_propH = mean(propH),
            SD = sd(propH),
            SE = sd(propH)/sqrt(n())
            )
Younger_high_clutch_means$AgeGroup <- 4.20
kable(Younger_high_clutch_means,digits=4)
```
20 pairs (taking out the ones with above threshold VOR)
The SE here is among clutches (per treatment). 

### middle age group

```{r}
Middle_by_clutch<-
  middle_jiggling %>%
  group_by(Clutch, Treatment) %>%
  summarize(num_tested = n(),
            num_hatched = sum(Response),
            propH = mean(sum(Response)/n())
            )
kable(Middle_by_clutch,digits=4)
```

```{r}
Middle_clutch_means<-
  Middle_by_clutch %>%
  group_by(Treatment) %>%
  summarize(num_clutches = n(),
            mean_propH = mean(propH),
            SD = sd(propH),
            SE = sd(propH)/sqrt(n())
            )
Middle_clutch_means$AgeGroup <- 4.7
kable(Middle_clutch_means,digits=4)
```
17 pairs (with and without taking out any after looking at VOR)

### older age group

```{r}
Older_by_clutch<-
  older_jiggling %>%
  group_by(Clutch, Treatment) %>%
  summarize(num_tested = n(),
            num_hatched = sum(Response),
            propH = mean(sum(Response)/n())
            )
kable(Older_by_clutch,digits=4)
```

```{r}
Older_clutch_means<-
  Older_by_clutch %>%
  group_by(Treatment) %>%
  summarize(num_clutches = n(),
            mean_propH = mean(propH),
            SD = sd(propH),
            SE = sd(propH)/sqrt(n())
            )
Older_clutch_means$AgeGroup <- 5.4
kable(Older_clutch_means,digits=4)
```
18 pairs (with and without taking out the ones with above threshold VOR)

### STATS

```{r}
glmm0 <- glmer(Response ~ 1 + (1|Clutch), family=binomial(logit), data=jiggling.df, glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))

glmm1 <- glmer(Response ~ Treatment + (1|Clutch), family=binomial(logit), data=jiggling.df, glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))

glmm2 <- glmer(Response ~ Age_groups_four + (1|Clutch), family=binomial(logit), data=jiggling.df, glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))

glmm3 <- glmer(Response ~ Treatment + Age_groups_four + (1|Clutch), family=binomial(logit), data=jiggling.df, glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))

glmm4 <- glmer(Response ~ Treatment * Age_groups_four + (1|Clutch), family=binomial(logit), data=jiggling.df, glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))

AIC(glmm0)
AIC(glmm1)
AIC(glmm2)
AIC(glmm3)
AIC(glmm4) ### best one

anova(glmm1,glmm3) # Age effect (GLMM, χ2=200.12, df=3, P<2.2e-16***)
anova(glmm2,glmm3) # Treatment effect (GLMM, χ2=105.7, df=1, P<2.2e-16***)
anova(glmm3,glmm4) # interaction effect (GLMM, χ2=19.928, df=3, P=0.0001757 ***)

Anova(glmm4) #all significant
# Age effect: (GLMM, χ2=81.373, df=3, P<2.2e-16***)
# Treatment effect: (GLMM, χ2=55.373, df=1, P=1.038e-13 ***)
# Interaction effect: (GLMM, χ2=11.777, df=3, P=0.008188 **)
```

```{r}
# just prior to vestibular function, at age 4.17 d, gentamicin reduced the hatching response to jiggling from 10% to 1%, revealing a lateral line contribution to risk assessment. 

young_jig_low_G <- subset(younger_jiggling_low, younger_jiggling_low$Treatment=="G") #143 individuals

hat_young_jig_low_G <- subset(young_jig_low_G, young_jig_low_G$Response == 1) #1
nohat_young_jig_low_G <- subset(young_jig_low_G, young_jig_low_G$Response == 0) #142

1/143 #0.006993007 #0.6993%

young_jig_low_NT <- subset(younger_jiggling_low, younger_jiggling_low$Treatment=="NT") #143 individuals

hat_young_jig_low_NT <- subset(young_jig_low_NT, young_jig_low_NT$Response == 1) #14
nohat_young_jig_low_NT <- subset(young_jig_low_NT, young_jig_low_NT$Response == 0) #129

14/143 #0.0979021 #9.79021%

```

```{r}
# just prior to vestibular function, at age 4.2 d, gentamicin reduced the hatching response to jiggling from 41% to 1.5%, revealing a lateral line contribution to risk assessment. 

young_jig_high_G <- subset(younger_jiggling_high, younger_jiggling_high$Treatment=="G") #129 individuals

hat_young_jig_high_G <- subset(young_jig_high_G, young_jig_high_G$Response == 1) #2
nohat_young_jig_high_G <- subset(young_jig_high_G, young_jig_high_G$Response == 0) #127

2/129 #0.01550388 #1.550388%

young_jig_high_NT <- subset(younger_jiggling_high, younger_jiggling_high$Treatment=="NT") #129 individuals

hat_young_jig_high_NT <- subset(young_jig_high_NT, young_jig_high_NT$Response == 1) #53
nohat_young_jig_high_NT <- subset(young_jig_high_NT, young_jig_high_NT$Response == 0) #76

53/129 #0.4108527 #41.08527%

```

```{r}
mid_jig_G <- subset(middle_jiggling, middle_jiggling$Treatment=="G") #180 individuals

hat_mid_jig_G <- subset(mid_jig_G, mid_jig_G$Response == 1) #74
nohat_mid_jig_G <- subset(mid_jig_G, mid_jig_G$Response == 0) #106

74/180 #0.4111111 #41.111111 %

mid_jig_NT <- subset(middle_jiggling, middle_jiggling$Treatment=="NT") #180 individuals

hat_mid_jig_NT <- subset(mid_jig_NT, mid_jig_NT$Response == 1) #126
nohat_mid_jig_NT <- subset(mid_jig_NT, mid_jig_NT$Response == 0) #54

126/180 #0.7 #70.00000 %

```

Moving on: Here we perform separate binomial GLMs at each age, with grouped categories of treatment stimuli. 

```{r}
#binomial glm for YOUNGER LOW 
temp0<-glmer(Response ~ 1 + (1|Clutch), family=binomial(logit), control=glmerControl(optimizer="bobyqa"), data=younger_jiggling_low)

temp1<-glmer(Response ~ Treatment + (1|Clutch), family=binomial(logit), control=glmerControl(optimizer="bobyqa"), data=younger_jiggling_low)

anova(temp0,temp1) #treatment effect

#binomial glm for YOUNGER HIGH 
temp0<-glmer(Response ~ 1 + (1|Clutch), family=binomial(logit), control=glmerControl(optimizer="bobyqa"), data=younger_jiggling_high)

temp1<-glmer(Response ~ Treatment + (1|Clutch), family=binomial(logit), control=glmerControl(optimizer="bobyqa"), data=younger_jiggling_high)

anova(temp0,temp1) #treatment effect

#binomial glm for MIDDLE (4d)
temp0<-glmer(Response ~ 1 + (1|Clutch), family=binomial(logit), control=glmerControl(optimizer="bobyqa"), data=middle_jiggling)

temp1<-glmer(Response ~ Treatment + (1|Clutch), family=binomial(logit), control=glmerControl(optimizer="bobyqa"), data=middle_jiggling)

anova(temp0,temp1) #treatment effect

#binomial glm for OLDER (5d)
##Not necessary bc esponse is constant
```

##Latency to hatch

### younger low age group

```{r}
Latency_younger_low_by_clutch <-
  younger_jiggling_low %>%
  group_by(Clutch, Treatment) %>%
  summarize(count = n(),
            ltoh = mean(Latency_min, na.rm=T),
            SD = sd(Latency_min, na.rm=T), 
            SE = sd(Latency_min, na.rm=T)/sqrt(n())
            )
kable(Latency_younger_low_by_clutch,digits=4)
```

```{r}
Latency_younger_low_clutch_means<-
  Latency_younger_low_by_clutch %>%
  group_by(Treatment) %>%
  summarize(num_clutches = n(),
            mean_ltoh = mean(ltoh, na.rm=T),
            SD = sd(ltoh, na.rm=T),
            SE = sd(ltoh, na.rm=T)/sqrt(n())
            )
Latency_younger_low_clutch_means$AgeGroup <- 4.17
kable(Latency_younger_low_clutch_means,digits=4)
```
### younger high age group

```{r}
Latency_younger_high_by_clutch <-
  younger_jiggling_high %>%
  group_by(Clutch, Treatment) %>%
  summarize(count = n(),
            ltoh = mean(Latency_min, na.rm=T),
            SD = sd(Latency_min, na.rm=T), 
            SE = sd(Latency_min, na.rm=T)/sqrt(n())
            )
kable(Latency_younger_high_by_clutch,digits=4)
```

```{r}
Latency_younger_high_clutch_means<-
  Latency_younger_high_by_clutch %>%
  group_by(Treatment) %>%
  summarize(num_clutches = n(),
            mean_ltoh = mean(ltoh, na.rm=T),
            SD = sd(ltoh, na.rm=T),
            SE = sd(ltoh, na.rm=T)/sqrt(n())
            )
Latency_younger_high_clutch_means$AgeGroup <- 4.20
kable(Latency_younger_high_clutch_means,digits=4)
```

### middle age group

```{r}
Latency_middle_by_clutch<-
  middle_jiggling %>%
  group_by(Clutch, Treatment) %>%
  summarize(count = n(),
            ltoh = mean(Latency_min, na.rm=T),
            SD = sd(Latency_min, na.rm=T), 
            SE = sd(Latency_min, na.rm=T)/sqrt(n())
            )
kable(Latency_middle_by_clutch,digits=4)
```

```{r}
Latency_middle_clutch_means<-
  Latency_middle_by_clutch %>%
  group_by(Treatment) %>%
  summarize(num_clutches = n(),
            mean_ltoh = mean(ltoh, na.rm=T),
            SD = sd(ltoh, na.rm=T),
            SE = sd(ltoh, na.rm=T)/sqrt(n())
            )
Latency_middle_clutch_means$AgeGroup <- 4.7
kable(Latency_middle_clutch_means,digits=4)
```
### older age group

```{r}
Latency_older_by_clutch<-
  older_jiggling %>%
  group_by(Clutch, Treatment) %>%
  summarize(count = n(),
            ltoh = mean(Latency_min, na.rm=T),
            SD = sd(Latency_min, na.rm=T), 
            SE = sd(Latency_min, na.rm=T)/sqrt(n())
            )
kable(Latency_older_by_clutch,digits=4)
```

```{r}
Latency_older_clutch_means<-
  Latency_older_by_clutch %>%
  group_by(Treatment) %>%
  summarize(num_clutches = n(),
            mean_ltoh = mean(ltoh, na.rm=T),
            SD = sd(ltoh, na.rm=T),
            SE = sd(ltoh, na.rm=T)/sqrt(n())
            )
Latency_older_clutch_means$AgeGroup <- 5.4
kable(Latency_older_clutch_means,digits=4)
```

### STATS

```{r}
hist(jiggling.df$Latency_min) #data are continuous, asymmetric, and outliers are mostly positive sided --> looks lognormal/gamma/weibull
hist(log(jiggling.df$Latency_min)) #looks normal actually

shapiro.test(jiggling.df$Latency_min) #not normal
shapiro.test(log(jiggling.df$Latency_min))#not normal
```

If p-value > 0.05 that implies that the distribution of the data are not significantly different from normal distribution. In other words, we can assume the normality. 

If p<0.05, not normal. 

```{r}
fit1<-fitdistr(jiggling.df$Latency_min[!is.na(jiggling.df$Latency_min)], "normal")
fit2<-fitdistr(jiggling.df$Latency_min[!is.na(jiggling.df$Latency_min)], "cauchy") 
fit3<-fitdistr(jiggling.df$Latency_min[!is.na(jiggling.df$Latency_min)], "lognormal")#must be positive
fit4<-fitdistr(jiggling.df$Latency_min[!is.na(jiggling.df$Latency_min)], "Gamma") #must be >=0
fit5<-fitdistr(jiggling.df$Latency_min[!is.na(jiggling.df$Latency_min)], "weibull")

#fit3<-fitdist(jiggling.df$Latency_min[!is.na(jiggling.df$Latency_min)], "beta") #must be between 0 and 1, beta means 0 heavy
#fit2<-fitdistr(jiggling.df$Latency_min[!is.na(jiggling.df$Latency_min)], "Binomial") #must be between 0 and 1
#fit5<-fitdistr(jiggling.df$Latency_min[!is.na(jiggling.df$Latency_min)], "Poisson") #must be count/integer values
#fit3<-fitdistr(jiggling.df$Latency_min[!is.na(jiggling.df$Latency_min)], "negative binomial") #must be count/integer values

AIC(fit1,fit2, fit3, fit4, fit5) # best to do gamma
```
Both the gamma and Weibull distributions can be seen as generalisations of the exponential distribution. If we look at the exponential distribution as describing the waiting time of a Poisson process (the time we have to wait until an event happens, if that event is equally likely to occur in any time interval), then the Γ(𝑘,𝜃) distribution describes the time we have to wait for 𝑘 independent events to occur.

On the other hand, the Weibull distribution effectively describes the time we have to wait for one event to occur, if that event becomes more or less likely with time. 

Consider latencies to be non-normal --> do an non-parametric analysis with glmms, family=gamma 
```{r}
glmm0 <- glmer(Latency_min ~ 1 + (1|Clutch), family=Gamma(inverse), data=jiggling.df)
glmm1 <- glmer(Latency_min ~ Treatment + (1|Clutch), family=Gamma(inverse), data=jiggling.df)
glmm2 <- glmer(Latency_min ~ Age_groups_four + (1|Clutch), family=Gamma(inverse), data=jiggling.df)
glmm3 <- glmer(Latency_min ~ Treatment + Age_groups_four + (1|Clutch), family=Gamma(inverse), data=jiggling.df)
glmm4 <- glmer(Latency_min ~ Treatment * Age_groups_four + (1|Clutch), family=Gamma(inverse), data=jiggling.df)

anova(glmm1, glmm3) # Age effect
anova(glmm2, glmm3) # Treatment effect
anova(glmm3, glmm4) # interaction effect
```

Moving on: Here we perform separate binomial GLMs at each age, with grouped categories of treatment stimuli. 

```{r}
# glmm for YOUNGER LOW
temp0<-glmer(Latency_min ~ 1 + (1|Clutch), family=Gamma(inverse), data=younger_jiggling_low)
temp1<-glmer(Latency_min ~ Treatment + (1|Clutch), family=Gamma(inverse), data=younger_jiggling_low)
anova(temp0, temp1) #treatment effect
#Anova(temp1)
```
There's no significant effect of treatment in younger embryos, but this is likely because the sample size for G treated embryos that hatched was so small (N=1). 

How many actually hatched?
```{r}
Latency_younger_low_by_response <-
  younger_jiggling_low %>%
  group_by(Treatment, Response) %>%
  summarize(count = n(),
            ltoh = mean(Latency_min, na.rm=T),
            SD = sd(Latency_min, na.rm=T), 
            SE = sd(Latency_min, na.rm=T)/sqrt(n())
            )
kable(Latency_younger_low_by_response,digits=4)
```

```{r}
# glmm for YOUNGER LOW
temp0<-glmer(Latency_min ~ 1 + (1|Clutch), family=Gamma(inverse), data=younger_jiggling_high)
temp1<-glmer(Latency_min ~ Treatment + (1|Clutch), family=Gamma(inverse), data=younger_jiggling_high)
anova(temp0, temp1) #treatment effect
#Anova(temp1)
```

There's no significant effect of treatment in younger embryos, but this is likely because the sample size for G treated embryos that hatched was so small (N=1). 

How many actually hatched?
```{r}
Latency_younger_high_by_response <-
  younger_jiggling_high %>%
  group_by(Treatment, Response) %>%
  summarize(count = n(),
            ltoh = mean(Latency_min, na.rm=T),
            SD = sd(Latency_min, na.rm=T), 
            SE = sd(Latency_min, na.rm=T)/sqrt(n())
            )
kable(Latency_younger_high_by_response,digits=4)
```

```{r}
# glmm for MIDDLE (4d)
temp0<-glmer(Latency_min ~ 1 + (1|Clutch), family=Gamma(inverse), data=middle_jiggling)
temp1<-glmer(Latency_min ~ Treatment + (1|Clutch), family=Gamma(inverse), data=middle_jiggling)
anova(temp0, temp1) #treatment effect
#Anova(temp1)
```

How many actually hatched?
```{r}
Latency_middle_by_response <-
  middle_jiggling %>%
  group_by(Treatment, Response) %>%
  summarize(count = n(),
            ltoh = mean(Latency_min, na.rm=T),
            SD = sd(Latency_min, na.rm=T), 
            SE = sd(Latency_min, na.rm=T)/sqrt(n())
            )
kable(Latency_middle_by_response,digits=4)
```

```{r}
# glmm for OLDER (5d)
temp0<-glmer(Latency_min ~ 1 + (1|Clutch), family=Gamma(inverse), data=older_jiggling)
temp1<-glmer(Latency_min ~ Treatment + (1|Clutch), family=Gamma(inverse), data=older_jiggling)
anova(temp0, temp1) #treatment effect
#Anova(temp1)
```

How many actually hatched?
```{r}
Latency_older_by_response <-
  older_jiggling %>%
  group_by(Treatment, Response) %>%
  summarize(count = n(),
            ltoh = mean(Latency_min, na.rm=T),
            SD = sd(Latency_min, na.rm=T), 
            SE = sd(Latency_min, na.rm=T)/sqrt(n())
            )
kable(Latency_older_by_response,digits=4)
```

# Figures

```{r}
treatmentcolors <- c('red', 'black')
#linetypes<-c("dotted", "solid", "dashed")
```

### PropH Figure

Combine summary data into one dataframe with all three age groups. 
```{r}
all_ages<-rbind(Younger_low_clutch_means, Younger_high_clutch_means, Middle_clutch_means, Older_clutch_means)
kable(all_ages,digits=4)
```

Figure with bigger style for poster and talks. 

```{r}
# plot.jiggle.hatch <- ggplot(all_ages, aes(x=AgeGroup, y=mean_propH, color=Treatment)) +
#   geom_point(size=3) +
#   geom_line(aes(color=Treatment), size=1.5)+
#   geom_errorbar(data=all_ages, aes(ymin=mean_propH-SE, ymax=mean_propH+SE), width=0.05, size=1.5) +
#   scale_x_continuous(limits=c(4.1,5.5),
#                      breaks=c(4.2, 4.7, 5.4),
#                      labels=c("4.2", "4.7", "5.4"))+
#   scale_y_continuous(limits = c(0, 1)) +
#   labs(x = NULL, 
#        y = "Hatching Response\n") +
#   scale_color_manual(name=NULL, 
#                      values=c(treatmentcolors[1], treatmentcolors[2]),
#                      labels=c("Treated", "Control")) +
#   theme_cowplot(font_size = 18, line_size = 1) +
#   theme(axis.text.y=element_text(size=18, colour= "black")) +
#   theme(axis.text.x=element_text(size=18, colour= "black")) +
#   theme(axis.title.x=element_text(size=18, colour = "black")) +
#   theme(axis.title.y=element_text(size=18, colour = "black")) +
#   theme(legend.justification = c(0,1), legend.position = c(0.05,1)) 
# 
# plot.jiggle.hatch
```

```{r}
#png("~/Desktop/Figure1.png", width = 18, height = 15, units = 'cm', res = 300)
#grid.arrange (Figure1) # Make plot
#dev.off()
```


```{r}
# ggsave("~/Desktop/plot_jiggle_hatch_v3.pdf",
# plot = plot.jiggle.hatch, # or give ggplot object name as in myPlot,
# width = 24, height = 14,
# units = "cm", # other options c("in", "cm", "mm"),
# dpi = 300)
# dev.off()
```

### LtoH Figure

Combine summary data into one dataframe with all three age groups. 
```{r}
latency_all_ages<-rbind(Latency_younger_low_clutch_means, Latency_younger_high_clutch_means, Latency_middle_clutch_means, Latency_older_clutch_means)
kable(latency_all_ages,digits=4)
```

Figure with bigger style for poster and talks
```{r}
#treatmentcolors <- c('red', 'black')

# plot.jiggle.latency <- ggplot(latency_all_ages, aes(x=AgeGroup, y=mean_ltoh, color=Treatment)) +
#   geom_point(size=3) +
#   geom_line(aes(color=Treatment), size=1.5)+
#   geom_errorbar(data=latency_all_ages, aes(ymin=mean_ltoh-SE, ymax=mean_ltoh+SE), width=0.05, size=1.5) +
#   scale_x_continuous(limits=c(4.1,5.5),
#                      breaks=c(4.2, 4.7, 5.4),
#                      labels=c("4.2", "4.7", "5.4"))+
#   scale_y_continuous(limits = c(0, 4.5), 
#                      breaks=c(0, 1.5, 3, 4.5),
#                      labels=c("0", "1.5", "3", "4.5"))+
#   labs(x = "\nAge Group (d)", 
#        y = "Latency to hatch (min)\n") +
#   scale_color_manual(name=NULL, 
#                      values=c(treatmentcolors[1], treatmentcolors[2]),
#                      labels=c("Treated", "Control")) +
#   theme_cowplot(font_size = 18, line_size = 1) +
#   theme(axis.text.y=element_text(size=18, colour= "black")) +
#   theme(axis.text.x=element_text(size=18, colour= "black")) +
#   theme(axis.title.x=element_text(size=18, colour = "black")) +
#   theme(axis.title.y=element_text(size=18, colour = "black")) +
#   theme(legend.justification = c(0,1), legend.position = c(0.75,1)) 
# 
# plot.jiggle.latency
```

```{r}
# ggsave("~/Desktop/plot_jiggle_latency_v3.pdf",
# plot = plot.jiggle.latency, # or give ggplot object name as in myPlot,
# width = 24, height = 14,
# units = "cm", # other options c("in", "cm", "mm"),
# dpi = 300)
# dev.off()
```

combine plots 
```{r}
# Load required package
# require(gridExtra)
# 
# Figure3 <- plot_grid(plot.jiggle.hatch, plot.jiggle.latency, labels = "AUTO", ncol = 1, align = 'v')

```

This figure looks pretty squished in the html preview, but when I save this figure to my desktop, all the things are proportional and pretty!

```{r}
# ggsave("~/Desktop/Figure3.pdf", 
#  plot = Figure3, # or give ggplot object name as in myPlot,
#  width = 18, height = 21, 
#  units = "cm", # other options c("in", "cm", "mm"), 
#  dpi = 300)
# dev.off()
```

### Figure for paper, not talk
```{r}
figure.jiggle.hatch <- ggplot(all_ages, aes(x=AgeGroup, y=mean_propH, color=Treatment)) +
  geom_point(size=2) +
  geom_line(aes(color=Treatment), size=1)+
  geom_errorbar(data=all_ages, aes(ymin=mean_propH-SE, ymax=mean_propH+SE), width=0.05, size=1) +
  scale_x_continuous(limits=c(4.1,5.5),
                     breaks=c(4.2, 4.7, 5.4),
                     labels=c("4.2", "4.7", "5.4"))+
    scale_y_continuous(limits=c(0, 1),
                     breaks=c(0, 0.5, 1),
                     labels=c("0","0.5","1.0"))+
  labs(x = NULL, 
       y = "Proportion hatched\n") +
  scale_color_manual(name=NULL, 
                     values=c(treatmentcolors[1], treatmentcolors[2]),
                     labels=c("Gentamicin", "Control")) +
  theme_cowplot(font_size = 12, line_size = 1, font_family="Helvetica") +
  theme(axis.text.y=element_text(size=12, colour= "black")) +
  theme(axis.text.x=element_text(size=12, colour= "black")) +
  theme(axis.title.x=element_text(size=12, colour = "black")) +
  theme(axis.title.y=element_text(size=12, colour = "black")) +
  theme(legend.justification = c(1,0), legend.position = c(0.9,0.1)) 

figure.jiggle.hatch
```

```{r}
figure.jiggle.latency <- ggplot(latency_all_ages, aes(x=AgeGroup, y=mean_ltoh, color=Treatment)) +
  geom_point(size=2) +
  geom_line(aes(color=Treatment), size=1)+
  geom_errorbar(data=latency_all_ages, aes(ymin=mean_ltoh-SE, ymax=mean_ltoh+SE), width=0.05, size=1) +
  scale_x_continuous(limits=c(4.1,5.5),
                     breaks=c(4.2, 4.7, 5.4),
                     labels=c("4.2", "4.7", "5.4"))+
  scale_y_continuous(limits = c(0, 4.5), 
                     breaks=c(0, 1.5, 3, 4.5),
                     labels=c("0", "1.5", "3", "4.5"))+
  labs(x = "\n Embryo age group (d)", 
       y = "Latency to hatch (min)\n") +
  scale_color_manual(name=NULL, 
                     values=c(treatmentcolors[1], treatmentcolors[2]),
                     labels=c("Gentamicin", "Control")) +
  theme_cowplot(font_size = 12, line_size = 1, font_family="Helvetica") +
  theme(axis.text.y=element_text(size=12, colour= "black")) +
  theme(axis.text.x=element_text(size=12, colour= "black")) +
  theme(axis.title.x=element_text(size=12, colour = "black")) +
  theme(axis.title.y=element_text(size=12, colour = "black")) +
  theme(legend.position = "none") 

figure.jiggle.latency
```

combine plots 
```{r}
Figure5v4 <- plot_grid(figure.jiggle.hatch, figure.jiggle.latency, labels = "AUTO", ncol = 1, align = 'v')

ggsave("~/Desktop/Figure5v4.pdf", 
 plot = Figure5v4, # or give ggplot object name as in myPlot,
 width = 10, height = 15, 
 units = "cm", # other options c("in", "cm", "mm"), 
 dpi = 300, 
 useDingbats=FALSE)
```

## test for synergism (LL && VOR)

look just specifically at the first jiggling time point (as an additional analysis, separate from the whole time series) because at that point you can assess if the contributions of ear & LL are additive or synergistic (more than additive) or partially redundant (less than additive). 

Test for the 2 main effects: VOR (+/–) and LL (+/–) and interaction. If the interaction is significant, it's not just additive -- what it *looks* like is a positive synergism (more than additive effect) but would be good to have clear stat support.

### younger age group

```{r}
Younger_low_by_clutch$AgeD<-4.17
Younger_high_by_clutch$AgeD<-4.20
Younger_by_clutch<-rbind(Younger_low_by_clutch, Younger_high_by_clutch)
```

```{r}
Fig6_inset <- Younger_by_clutch %>%
  group_by(AgeD, Treatment) %>%
  summarize(Mean = mean(propH), 
            N = length(propH),
            SE = sd(propH)/sqrt(N)) %>% 
  ggplot(aes(x=Treatment, y=Mean, fill=Treatment))+ 
    geom_col(position="dodge", 
             width=0.4)+ 
    geom_errorbar(aes(ymax = Mean + SE, ymin = Mean - SE, width=0.1), col="darkgray")+
  facet_wrap(facets=.~AgeD)+ 
  xlab(NULL)+
  ylab("Proportion hatched")+ 
  scale_fill_manual(values=c("red","black"),
                    name="Treatment", 
                    labels=c("Gentamicin","Control"))+
  theme_cowplot(font_size = 8, line_size = 1, font_family="Helvetica") +
  theme(axis.text.y=element_text(size=8, colour= "black")) +
  theme(axis.text.x=element_text(size=8, colour= "black")) +
  theme(axis.title.x=element_text(size=8, colour = "black")) +
  theme(axis.title.y=element_text(size=8, colour = "black")) +
  theme(legend.position = "none")

Fig6_inset
```

```{r}
ggsave("~/Desktop/Fig5_inset.pdf", 
 plot = Fig5_inset, # or give ggplot object name as in myPlot,
 width = 5, height = 5, 
 units = "cm", # other options c("in", "cm", "mm"), 
 dpi = 300, 
 useDingbats=FALSE)
```

For figure in ms, not PPT. 
```{r}
NTyoung<-subset(Younger_by_clutch, Treatment=="NT")
GTyoung<-subset(Younger_by_clutch, Treatment=="G")

VOR_names <- c('4.17' = "No VOR",
               '4.2' = "With VOR")
  
Fig5_inset_boxplot <- Younger_by_clutch %>%
  ggplot(aes(x=Treatment, y=propH, group=Treatment))+ 
    geom_boxplot(position="dodge", 
             width=0.4, outlier.shape = NA)+ 
    geom_jitter(data=NTyoung, aes(x=Treatment, y=propH), colour="black", pch=16, size=2, position=position_jitter(width=0.1)) +
  geom_jitter(data=GTyoung, aes(x=Treatment, y=propH), colour="red", pch=16, size=2,  position=position_jitter(width=0.1)) +
  facet_wrap(facets=.~AgeD, labeller = as_labeller(VOR_names))+ 
  scale_y_continuous(limits=c(0, 1.05),
                     breaks=c(0, 0.5, 1),
                     labels=c("0","0.5","1.0"))+
  scale_x_discrete(labels=c("G", "C")) +
  labs(x = NULL, 
       y = "Proportion hatched\n") +
  theme_cowplot(font_size = 12, line_size = 1, font_family="Helvetica") +
  theme(strip.text.x = element_text(size = 12, color = "black", face = "bold"),
        strip.text.y = element_text(size = 12, color = "black", face = "bold")) + #bold.italic
  theme(axis.text.y=element_text(size=12, colour= "black")) +
  theme(axis.text.x=element_text(size=12, colour= "black")) +
  theme(axis.title.x=element_text(size=12, colour = "black")) +
  theme(axis.title.y=element_text(size=12, colour = "black")) +
  theme(legend.position = "none")

Fig5_inset_boxplot
```

```{r}
# ggsave("~/Desktop/Fig5_inset-v2.pdf", 
#  plot = Fig5_inset_boxplot, # or give ggplot object name as in myPlot,
#  width = 10, height = 10, 
#  units = "cm", # other options c("in", "cm", "mm"), 
#  dpi = 300, 
#  useDingbats=FALSE)
```


### 3 part figure 

combine plots 
```{r}
Figure5v5 <- plot_grid(Fig5_inset_boxplot, figure.jiggle.hatch, figure.jiggle.latency, labels = "AUTO", ncol = 1, align = 'v', axis = "lrtb", rel_heights = c(1.1, 1.05, 1.2))

ggsave("~/Desktop/Figure5v5.pdf", 
 plot = Figure5v5, # or give ggplot object name as in myPlot,
 width = 10, height = 20, 
 units = "cm", # other options c("in", "cm", "mm"), 
 dpi = 300, 
 useDingbats=FALSE)
```

Fits the beta-binomial model and the chance-corrected beta-binomial model to (over-dispersed) binomial data.
```{r}
library(aod) #betabin in package aod

bb0<-betabin(cbind(num_hatched, num_tested-num_hatched)~1, ~1, data=Younger_by_clutch)

bb1<-betabin(cbind(num_hatched, num_tested-num_hatched)~AgeD, ~1, data=Younger_by_clutch)

bb2<-betabin(cbind(num_hatched, num_tested-num_hatched)~Treatment, ~1, data=Younger_by_clutch)

bb3<-betabin(cbind(num_hatched, num_tested-num_hatched)~AgeD + Treatment, ~1, data=Younger_by_clutch)

bb4<-betabin(cbind(num_hatched, num_tested-num_hatched)~AgeD * Treatment, ~1, data=Younger_by_clutch)

# ~1 is to factor for overdispersion

summary(bb0) #phi.(intercept) is a value for overdispersion, which is not actually that bad... 
anova(bb1, bb3) #treatment effect
anova(bb2, bb3) #age/VOR effect
anova(bb3, bb4) #no interaction effect
#### so significant that the P value is 0??

```

The dunn.test is a nonparametric alternative to tukey/ multiple comparisons. 
```{r}
library(dunn.test)

Younger_by_clutch$TreatmentVOR <- as.factor(paste(Younger_by_clutch$Treatment, Younger_by_clutch$AgeD, sep="-"))

dunn.test(Younger_by_clutch$propH, Younger_by_clutch$TreatmentVOR, method = "bonferroni")
```

```{r}
Younger_by_clutch$TreatmentVOR <- as.factor(paste(Younger_by_clutch$Treatment, Younger_by_clutch$AgeD, sep="-"))

mod<-betabin(cbind(num_hatched, num_tested-num_hatched) ~ TreatmentVOR, ~1, data=Younger_by_clutch)

ph3<-glht(mod, linfct=mcp(TreatmentVOR="Tukey")) 
summary(ph3)
cld(ph3)
```

```{r}
younger_jiggling$TreatmentVOR <- as.factor(paste(younger_jiggling$Treatment, younger_jiggling$Age_groups_four, sep="-"))

mod<-glmer(Response ~ TreatmentVOR + (1|Clutch), family=binomial("logit"), data=younger_jiggling) 
ph3<-glht(mod, linfct=mcp(TreatmentVOR="Tukey")) 
summary(ph3)
cld(ph3)

```

```{r}
mod<-glmer(cbind(num_tested, num_hatched) ~ TreatmentVOR + (1|Clutch), family=binomial("logit"), data=Younger_by_clutch) 
ph3<-glht(mod, linfct=mcp(TreatmentVOR="Tukey")) 
summary(ph3)
cld(ph3)
```

for proportions, use a beta distribution. 
package betareg, beta regression. 
should account for having too many 0s
cani do mixed models with it? yes 

account for 0 inflation in a regular regression

Response - 

```{r}
Younger_by_clutch$TreatmentVOR <- as.factor(paste(Younger_by_clutch$Treatment, Younger_by_clutch$AgeD, sep="-"))

mod1<-glmer(cbind(num_tested-num_hatched, num_hatched) ~ 1 + (1|Clutch), family=binomial("logit"), data=Younger_by_clutch) 
mod2<-glmer(cbind(num_tested-num_hatched, num_hatched) ~ Treatment + (1|Clutch), family=binomial("logit"), data=Younger_by_clutch) 
mod3<-glmer(cbind(num_tested-num_hatched, num_hatched) ~ AgeD + (1|Clutch), family=binomial("logit"), data=Younger_by_clutch) 
mod4<-glmer(cbind(num_tested-num_hatched, num_hatched) ~ AgeD + Treatment + (1|Clutch), family=binomial("logit"), data=Younger_by_clutch) 
mod5<-glmer(cbind(num_tested-num_hatched, num_hatched) ~ AgeD * Treatment + (1|Clutch), family=binomial("logit"), data=Younger_by_clutch) 

anova(mod4, mod5)
```



```{r}
Younger_by_age_treatment_clutch<-
  younger_jiggling %>%
  group_by(Age_groups_four, Treatment, Clutch) %>%
  summarize(num_tested = n(),
            num_hatched = sum(Response),
            propH = mean(sum(Response)/n())
            )
kable(Younger_by_age_treatment_clutch,digits=4)
```

The proportion hatched here is per treatment, per clutch. 

```{r}
Younger_clutch_means<-
  Younger_by_age_treatment_clutch %>%
  group_by(Age_groups_four, Treatment) %>%
  summarize(num_clutches = n(),
            mean_propH = mean(propH),
            SD = sd(propH),
            SE = sd(propH)/sqrt(n())
            )
Younger_clutch_means$AgeGroup <- c(4.20, 4.20, 4.17, 4.17)
kable(Younger_clutch_means,digits=4)
```


```{r}
figure.youngins.hatch <- ggplot(Younger_clutch_means, aes(x=AgeGroup, y=mean_propH, color=Treatment)) +
  geom_point(size=2) +
  geom_line(aes(color=Treatment), size=1)+
  geom_errorbar(data=Younger_clutch_means, aes(ymin=mean_propH-SE, ymax=mean_propH+SE), width=0.002, size=1) +
  scale_x_continuous(limits=c(4.16, 4.21),
                     breaks=c(4.17, 4.2),
                     labels=c("4.17", "4.2"))+
  scale_y_continuous(limits = c(0, 0.6)) +
  labs(x = "Age (d)", 
       y = "Proportion hatched\n") +
  scale_color_manual(name=NULL, 
                     values=c(treatmentcolors[1], treatmentcolors[2]),
                     labels=c("Gentamicin", "Control")) +
  theme_cowplot(font_size = 12, line_size = 1, font_family="Helvetica") +
  theme(axis.text.y=element_text(size=12, colour= "black")) +
  theme(axis.text.x=element_text(size=12, colour= "black")) +
  theme(axis.title.x=element_text(size=12, colour = "black")) +
  theme(axis.title.y=element_text(size=12, colour = "black")) +
  theme(legend.justification = c(1,0), legend.position = c(0.3,0.8)) 

figure.youngins.hatch
```

```{r}
str(Younger_by_clutch)
glmm0 <- glmer(cbind(num_hatched, num_tested-num_hatched) ~ 1 + (1|Clutch), family=binomial(logit), data=Younger_by_clutch)

glmm1 <- glmer(cbind(num_hatched, num_tested-num_hatched) ~ as.factor(Treatment) + (1|Clutch), family=binomial(logit), data=Younger_by_clutch)

glmm2 <- glmer(cbind(num_hatched, num_tested-num_hatched) ~ as.factor(AgeD)  + (1|Clutch), family=binomial(logit), data=Younger_by_clutch)

glmm3 <- glmer(cbind(num_hatched, num_tested-num_hatched) ~ as.factor(AgeD) + as.factor(Treatment) + (1|Clutch), family=binomial(logit), data=Younger_by_clutch)

glmm4 <- glmer(cbind(num_hatched, num_tested-num_hatched) ~ as.factor(AgeD) * as.factor(Treatment)  + (1|Clutch), family=binomial(logit), data=Younger_by_clutch)

AIC(glmm0)
AIC(glmm1)
AIC(glmm2)
AIC(glmm3) ###
AIC(glmm4) ###

anova(glmm1,glmm3, test="Chisq") # vor effect
anova(glmm2,glmm3, test="Chisq") # LL effect
anova(glmm3,glmm4, test="Chisq") # no interaction effect 

Anova(glmm4, test="Chisq")
```

```{r}
glmm0 <- glmer(cbind(num_hatched, num_tested-num_hatched) ~ 1 + (1|Clutch), family=binomial(logit), data=Younger_by_age_treatment_clutch)

glmm1 <- glmer(cbind(num_hatched, num_tested-num_hatched) ~ as.factor(Treatment) + (1|Clutch), family=binomial(logit), data=Younger_by_age_treatment_clutch)

glmm2 <- glmer(cbind(num_hatched, num_tested-num_hatched) ~ as.factor(Age_groups_four)  + (1|Clutch), family=binomial(logit), data=Younger_by_age_treatment_clutch)

glmm3 <- glmer(cbind(num_hatched, num_tested-num_hatched) ~ Treatment + as.factor(Age_groups_four)  + (1|Clutch), family=binomial(logit), data=Younger_by_age_treatment_clutch)

glmm4 <- glmer(cbind(num_hatched, num_tested-num_hatched) ~ as.factor(Treatment) * as.factor(Age_groups_four)  + (1|Clutch), family=binomial(logit), data=Younger_by_age_treatment_clutch)

AIC(glmm0)
AIC(glmm1)
AIC(glmm2)
AIC(glmm3) ###
AIC(glmm4) ###

anova(glmm1,glmm3, test="Chisq") # vor effect
anova(glmm2,glmm3, test="Chisq") # LL effect
anova(glmm3,glmm4, test="Chisq") # no interaction effect 

Anova(glmm4, test="Chisq")
```

Looks additive and not synergistic. 

```{r}
glmer0 <- glmer(Response ~ 1 + (1|Clutch), family=binomial(logit), data=younger_jiggling)

glmer1 <- glmer(Response ~ as.factor(Treatment) + (1|Clutch), family=binomial(logit), data=younger_jiggling)

glmer2 <- glmer(Response ~ as.factor(Age_groups_four)  + (1|Clutch), family=binomial(logit), data=younger_jiggling)

glmer3 <- glmer(Response ~ as.factor(Treatment) + as.factor(Age_groups_four)  + (1|Clutch), family=binomial(logit), data=younger_jiggling)

glmer4 <- glmer(Response ~ as.factor(Treatment) * as.factor(Age_groups_four)  + (1|Clutch), family=binomial(logit), data=younger_jiggling)

AIC(glmer0)
AIC(glmer1)
AIC(glmer2)
AIC(glmer3) ###
AIC(glmer4) ###

anova(glmer1,glmer3) # vor effect
anova(glmer2,glmer3) # LL effect
anova(glmer3,glmer4) # no interaction effect 

Anova(glmer4) ### report?
plot(glmer4)
```
 
#try 0 inflated binomial

```{r}
glmer0 <- glmer.nb(Response ~ 1 + (1|Clutch), family=binomial(logit), data=younger_jiggling)

glmer1 <- glmer.nb(Response ~ as.factor(Treatment) + (1|Clutch), family=binomial(logit), data=younger_jiggling)

glmer2 <- glmer.nb(Response ~ as.factor(Age_groups_four)  + (1|Clutch), family=binomial(logit), data=younger_jiggling)

glmer3 <- glmer.nb(Response ~ as.factor(Treatment) + as.factor(Age_groups_four)  + (1|Clutch), family=binomial(logit), data=younger_jiggling)

glmer4 <- glmer.nb(Response ~ as.factor(Treatment) * as.factor(Age_groups_four)  + (1|Clutch), family=binomial(logit), data=younger_jiggling)

AIC(glmer0)
AIC(glmer1)
AIC(glmer2)
AIC(glmer3) ###
AIC(glmer4) ###

anova(glmer1,glmer3) # vor effect
anova(glmer2,glmer3) # LL effect
anova(glmer3,glmer4) # no interaction effect 

Anova(glmer4) ### report?
plot(glmer4)
```


```{r}
# install.packages("R2admb")
# install.packages("glmmADMB", 
#     repos=c("http://glmmadmb.r-forge.r-project.org/repos",
#             getOption("repos")),
#     type="source")
# 
# library(glmmADMB)

younger_jiggling$Treatment.factor<-as.factor(younger_jiggling$Treatment)
younger_jiggling$Age_groups_four.factor<-as.factor(younger_jiggling$Age_groups_four)
younger_jiggling$Clutch.factor<-as.factor(younger_jiggling$Clutch)

glmm1<-glmmadmb(Response~Treatment.factor+Age_groups_four.factor +(1|Clutch.factor),
                family="binomial", data=younger_jiggling)

glmm1.1<-glmmadmb(Response~Treatment.factor+(1|Clutch.factor), family="binomial", data=younger_jiggling)

glmm1.2<-glmmadmb(Response~Age_groups_four.factor+(1|Clutch.factor), family="binomial", data=younger_jiggling) 

glmm1.3<-glmmadmb(Response~Treatment.factor*Age_groups_four.factor+(1|Clutch.factor), family="binomial", data=younger_jiggling)

anova(glmm1,glmm1.1)#sig of VOR

anova(glmm1,glmm1.2)#sig of Treatment

anova(glmm1,glmm1.3)#Sig of interaction
```
# TRAY DATA

subset playback to tray data only
```{r}
#playback.df <- subset(all_data, Experiment=="Tray")
```

```{r} 
playback.df$PropNH <- playback.df$EP3m/playback.df$TestEggs
playback.df$PropH <- (playback.df$TestEggs-playback.df$EP3m)/playback.df$TestEggs
```

Format latency data correctly, as numbers. 
```{r}
#str(playback.df)

#playback.df[,10:50]<- lapply(10:50, function(x)
#  as.numeric(playback.df[[x]]))
```

Deal with latencies --> turn into minutes
```{r}
playback.df$Stimulus_start <- playback.df$PBKhour*60 + playback.df$PBKmin + playback.df$PBKsec/60
playback.df$First_hatch_time<- playback.df$FirstHhour*60 + playback.df$FirstHmin + playback.df$FirstHsec/60

playback.df$First_latency_min <- playback.df$First_hatch_time - playback.df$Stimulus_start
```

Calculate stimulus start age in days
```{r}
playback.df$Stimulus_start_age <- 5 + playback.df$PBKhour/24 + playback.df$PBKmin/(24*60) + playback.df$PBKsec/(24*60*60) # Stimulus_start_age is in days
```

Calculate average stage per tray
```{r}
playback.df$Stage_average <- (playback.df$Stage1 + playback.df$Stage2 + playback.df$Stage3)/3
```

Calculate the average VOR amplitude from both ears
```{r}
playback.df$Average_amplitude <- (playback.df$Amplitude_right + playback.df$Amplitude_left)/2
```

Subset out trays with 7 or fewer eggs (include trays with at least 8 eggs)
```{r}
test <- subset(playback.df, playback.df$TestEggs>7)
```

How many trays did we shake? How many individuals? From how many clutches? And from what dates?

```{r}
#96 trays/rows in test playback dataframe
sum(test$TestEggs) #1132 individual test eggs

Playback_by_clutch<-
  test %>%
  group_by(Clutch) %>%
  summarize(num_tested = n())
kable(Playback_by_clutch,digits=4) #63 clutches
nrow(Playback_by_clutch)

min(test$Date)
max(test$Date)
```

What is the age range and stage range of tested playback individuals?
```{r}
Playback_stAGE<-
  test %>%
  summarize(num_tested = n(),
            mean_stim_start_age = mean(Stimulus_start_age),
            SD_age = sd(Stimulus_start_age),
            SE_age = sd(Stimulus_start_age)/sqrt(n()), 
            mean_stim_start_stage = mean(Stage_average),
            SD_stage = sd(Stage_average),
            SE_stage = sd(Stage_average)/sqrt(n())
            )
kable(Playback_stAGE,digits=4)

```

Was there any hatching induced by the set up procedure? How many hatched post stimulus? How many eggs which remained unhatched were confirmed hatched competent?

```{r}
sum(test$EpreSU - test$EpostSU) #3 induced by set up

sum(test$EpostSU - test$TestEggs) #38 during acclimation

sum(test$EPPBK - test$EP3m) #3 post playback

sum(test$EP3m) #251
```

How often did we measure VOR? 
```{r}
VOR_stats_playback <-
  test %>%
  filter(!is.na(Sample_name)) %>%
  group_by(Treatment) %>%
  summarize(num_tested = n(),
            meanVOR = mean(Average_amplitude),
            SD = sd(Average_amplitude),
            SE = sd(Average_amplitude)/sqrt(n())
            )

kable(VOR_stats_playback,digits=4)
```

How often did we check for LL blockage?
```{r}
LL_stats_playback <-
  test %>%
  filter(!is.na(LL1start)) %>%
  group_by(Treatment) %>%
  summarize(num_tested = n())

kable(LL_stats_playback,digits=4)
```

How many clutches are there where I have VOR measurements from pairs (NT and G)
vs. how many clutches where addition data with no pairs. 

```{r}
Playback_by_clutch_treatment<-
  test %>%
  group_by(Clutch, Treatment) %>%
  summarize(num_tested = n())%>%
  mutate(count=n())
kable(Playback_by_clutch_treatment,digits=4)

single<-subset(Playback_by_clutch_treatment, Playback_by_clutch_treatment$count==1) #41 clutches
double<-subset(Playback_by_clutch_treatment, Playback_by_clutch_treatment$count==2) #22 clutches
```


##Proportion Hatched

```{r}
quantile(test$PropH)
```

```{r}
playbacks_by_treatment<-
  test %>%
  group_by(Treatment) %>%
  summarize(count = n(),
            proph = mean(PropH, na.rm=T),
            SD = sd(PropH, na.rm=T), 
            SE = sd(PropH, na.rm=T)/sqrt(n())
            )
kable(playbacks_by_treatment,digits=4)
```

Subset out trays by treatment
```{r}
NT <- subset(test, test$Treatment == "NT")
GT <- subset(test, test$Treatment == "G")

NT$PropH
```

By 5 days of age, there is no significant difference in proportion of tray hatched (GLMM, χ2=1.8081, df=1, P=0.1787, Fig. 6a) between gentamicin treated and untreated control individuals.

```{r}
str(test)
hist(log(test$PropH))
shapiro.test(test$PropH) #not normal
shapiro.test(log(test$PropH)) #should use non parametric

test$Num_hatched <- test$TestEggs - test$EP3m
test$Stage_average <- as.factor(test$Stage_average)

glmm0 <- glmer(cbind(Num_hatched, TestEggs) ~ 1 + (1|Clutch), family=binomial(logit), data=test)
glmm1 <- glmer(cbind(Num_hatched, TestEggs) ~ Treatment + (1|Clutch), family=binomial(logit), data=test)
glmm2 <- glmer(cbind(Num_hatched, TestEggs) ~ Stage_average + (1|Clutch), family=binomial(logit), data=test)
glmm3 <- glmer(cbind(Num_hatched, TestEggs) ~ Treatment + Stage_average + (1|Clutch), family=binomial(logit), data=test)
glmm4 <- glmer(cbind(Num_hatched, TestEggs) ~ Treatment * Stage_average + (1|Clutch), family=binomial(logit), data=test)

anova(glmm1, glmm3) # No stage effect
anova(glmm2, glmm3) # No treatment effect *** Reported
anova(glmm3, glmm4) # No interaction effect
```

## L to H

By 5 days of age, there is no significant difference in the latency for the first embryo in the tray to hatch (GLMM, χ2=2.3565, df=1, P=0.1248, Fig. 6b) between gentamicin treated and untreated control individuals.

```{r}
hist(test$First_latency_min)
hist(log(test$First_latency_min))
shapiro.test(test$First_latency_min) #not normal
shapiro.test(log(test$First_latency_min)) #should use non parametric

#test$Stage_average <- as.factor(test$Stage_average)

glmm0 <- glmer(First_latency_min ~ 1 + (1|Clutch), family=Gamma(inverse), data=test)
glmm1 <- glmer(First_latency_min ~ Treatment + (1|Clutch), family=Gamma(inverse), data=test)
glmm2 <- glmer(First_latency_min ~ Stage_average + (1|Clutch), family=Gamma(inverse), data=test, glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
glmm3 <- glmer(First_latency_min ~ Treatment + Stage_average + (1|Clutch), family=Gamma(inverse), data=test, glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
glmm4 <- glmer(First_latency_min ~ Treatment * Stage_average + (1|Clutch), family=Gamma(inverse), data=test, glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))

anova(glmm1, glmm3) # No stage effect
anova(glmm2, glmm3) # No treatment effect ***
anova(glmm3, glmm4) # No interaction effect
```

# Figures

Subset out trays by treatment
```{r}
NT <- subset(test, test$Treatment == "NT")
GT <- subset(test, test$Treatment == "G")
```

The following code creates our figure:

```{r}
#treatmentcolors <- c('red', 'black')
# 
# Figure6a_v2<-ggplot(data=test, aes(x=Treatment, y=PropH, color=Treatment)) + 
#   geom_boxplot(alpha = 1, size = 1, width = 0.15, outlier.shape=NA) +
#   geom_jitter(data=NT, aes(x=Treatment, y=PropH), colour="black", pch=16, size=3, position=position_jitter(width=0.05)) +
#   geom_jitter(data=GT, aes(x=Treatment, y=PropH), colour="red", pch=16, size=3,  position=position_jitter(width=0.05)) +
#   scale_y_continuous(limits=c(0, 1.05),
#                      breaks=c(0, 0.25, 0.5, 0.75, 1),
#                      labels=c("0", "0.25","0.5", "0.75","1.0"))+
#   scale_x_discrete(labels=c("Treated", "Control")) +
#   labs(x = "\n Treatment", 
#        y = "Proportion of tray hatched \n") +
#   scale_color_manual(name=NULL, 
#                      values=c(treatmentcolors[1], treatmentcolors[2]),
#                      labels=c("Treated", "Control")) +
#   theme_cowplot(font_size = 18, line_size = 1) +
#   theme(axis.text.y=element_text(size=18, colour= "black")) +
#   theme(axis.text.x=element_text(size=18, colour= "black")) +
#   theme(axis.title.x=element_text(size=18, colour = "black")) +
#   theme(axis.title.y=element_text(size=18, colour = "black")) +
#   theme(legend.position = "none")
# 
# Figure6a_v2
```

```{r}
# ggsave("~/Desktop/plot_trays_forJenni_v1.pdf",
# plot = Figure6a_v2, # or give ggplot object name as in myPlot,
# width = 24, height = 14,
# units = "cm", # other options c("in", "cm", "mm"),
# dpi = 300)
# dev.off()
```

For figure in ms, not PPT. 
```{r}
#treatmentcolors <- c('red', 'black')

Figure6a_v3<-ggplot(data=test, aes(x=Treatment, y=PropH, color=Treatment)) + 
  geom_boxplot(alpha = 1, size = 1, width = 0.15, outlier.shape=NA) +
  geom_jitter(data=NT, aes(x=Treatment, y=PropH), colour="black", pch=16, size=2, position=position_jitter(width=0.05)) +
  geom_jitter(data=GT, aes(x=Treatment, y=PropH), colour="red", pch=16, size=2,  position=position_jitter(width=0.05)) +
  scale_y_continuous(limits=c(0, 1.05),
                     breaks=c(0, 0.25, 0.5, 0.75, 1),
                     labels=c("0", "0.25","0.5", "0.75","1.0"))+
  scale_x_discrete(labels=c("Gentamicin", "Control")) +
  labs(x = NULL,
       y = "Proportion hatched \n") +
  scale_color_manual(name=NULL, 
                     values=c(treatmentcolors[1], treatmentcolors[2]),
                     labels=c("Gentamicin", "Control")) +
  theme_cowplot(font_size = 12, line_size = 1, font_family="Helvetica") +
  theme(axis.text.y=element_text(size=12, colour= "black")) +
  theme(axis.text.x=element_text(size=12, colour= "black")) +
  theme(axis.title.x=element_text(size=12, colour = "black")) +
  theme(axis.title.y=element_text(size=12, colour = "black")) +
  theme(legend.position = "none")

Figure6a_v3
```

```{r}
latencies_by_treatment<-
  test %>%
  group_by(Treatment) %>%
  summarize(count = n(),
            ltoh = mean(First_latency_min, na.rm=T),
            SD = sd(First_latency_min, na.rm=T), 
            SE = sd(First_latency_min, na.rm=T)/sqrt(n())
            )
kable(latencies_by_treatment,digits=4)
```

```{r}
#treatmentcolors <- c('red', 'black')

# Figure6b_v2<-ggplot(data=test, aes(x=Treatment, y=First_latency_min, color=Treatment)) + 
#   geom_boxplot(alpha = 1, size = 1, width = 0.15, outlier.shape=NA) +
#   geom_jitter(data=NT, aes(x=Treatment, y=First_latency_min), colour="black", pch=16, size=3, position=position_jitter(width=0.05)) +
#   geom_jitter(data=GT, aes(x=Treatment, y=First_latency_min), colour="red", pch=16, size=3,  position=position_jitter(width=0.05)) +
#   scale_y_continuous(limits=c(0, 2),
#                      breaks=c(0, 0.5, 1, 1.5, 2),
#                      labels=c("0", "0.5", "1", "1.5", "2"))+
#   scale_x_discrete(labels=c("Gentamicin", "Control")) +
#   labs(x = NULL, 
#        y = "Latency to first hatch (min) \n") +
#   scale_color_manual(name=NULL, 
#                      values=c(treatmentcolors[1], treatmentcolors[2]),
#                      labels=c("Gentamicin", "Control")) +
#   theme_cowplot(font_size = 18, line_size = 1, font_family="Helvetica") +
#   theme(axis.text.y=element_text(size=18, colour= "black")) +
#   theme(axis.text.x=element_text(size=18, colour= "black")) +
#   theme(axis.title.x=element_text(size=18, colour = "black")) +
#   theme(axis.title.y=element_text(size=18, colour = "black")) +
#   theme(legend.position = "none")
# 
# Figure6b_v2
```

```{r}
# ggsave("~/Desktop/plot_trays_forJenni_v2.pdf",
# plot = Figure6b_v2, # or give ggplot object name as in myPlot,
# width = 24, height = 14,
# units = "cm", # other options c("in", "cm", "mm"),
# dpi = 300)
# dev.off()
```


```{r}
#treatmentcolors <- c('red', 'black')

Figure6b_v3<-ggplot(data=test, aes(x=Treatment, y=First_latency_min, color=Treatment)) + 
  geom_boxplot(alpha = 1, size = 1, width = 0.15, outlier.shape=NA) +
  geom_jitter(data=NT, aes(x=Treatment, y=First_latency_min), colour="black", pch=16, size=2, position=position_jitter(width=0.05)) +
  geom_jitter(data=GT, aes(x=Treatment, y=First_latency_min), colour="red", pch=16, size=2,  position=position_jitter(width=0.05)) +
  scale_y_continuous(limits=c(0, 2),
                     breaks=c(0, 0.5, 1, 1.5, 2),
                     labels=c("0", "0.5", "1", "1.5", "2"))+
  scale_x_discrete(labels=c("Gentamicin", "Control")) +
  labs(x = NULL, 
       y = "First hatching (min) \n") +
  scale_color_manual(name=NULL, 
                     values=c(treatmentcolors[1], treatmentcolors[2]),
                     labels=c("Gentamicin", "Control")) +
  theme_cowplot(font_size = 12, line_size = 1, font_family="Helvetica") +
  theme(axis.text.y=element_text(size=12, colour= "black")) +
  theme(axis.text.x=element_text(size=12, colour= "black")) +
  theme(axis.title.x=element_text(size=12, colour = "black")) +
  theme(axis.title.y=element_text(size=12, colour = "black")) +
  theme(legend.position = "none")

Figure6b_v3
```
combine plots 
```{r}
Figure6_v1 <- plot_grid(Figure6a_v3, Figure6b_v3, labels = "AUTO", ncol = 2, align = 'h')

ggsave("~/Desktop/Figure6_v1.pdf", 
 plot = Figure6_v1, # or give ggplot object name as in myPlot,
 width = 15, height = 10, 
 units = "cm", # other options c("in", "cm", "mm"), 
 dpi = 300, 
 useDingbats=FALSE)
```

## Hatching curves

I want to make a figure of proportion of tray hatched on the y-axis and time on the x axis, with G and NT treatments colored differently. 

First make new dataframe such that each tray has rows for all 15 embryos. Then with the cumulative sum of the number hatched and the cumulative sum of the test eggs, you can get the proportion. 
Deal with latencies --> turn into seconds
```{r}
playback.df$Stimulus_start_sec <- playback.df$PBKhour*60*60 + playback.df$PBKmin*60 + playback.df$PBKsec
playback.df$First_hatch_time_sec<- playback.df$FirstHhour*60*60 + playback.df$FirstHmin*60 + playback.df$FirstHsec
playback.df$Second_hatch_time_sec<- playback.df$SecondHhour*60*60 + playback.df$SecondHmin*60 + playback.df$SecondHsec
playback.df$Third_hatch_time_sec<- playback.df$ThirdHhour*60*60 + playback.df$ThirdHmin*60 + playback.df$ThirdHsec
playback.df$Fourth_hatch_time_sec<- playback.df$FourthHhour*60*60 + playback.df$FourthHmin*60 + playback.df$FourthHsec
playback.df$Fifth_hatch_time_sec<- playback.df$FifthHhour*60*60 + playback.df$FifthHmin*60 + playback.df$FifthHsec
playback.df$Sixth_hatch_time_sec<- playback.df$SixthHhour*60*60 + playback.df$SixthHmin*60 + playback.df$SixthHsec
playback.df$Seventh_hatch_time_sec<- playback.df$SeventhHhour*60*60 + playback.df$SeventhHmin*60 + playback.df$SeventhHsec
playback.df$Eighth_hatch_time_sec<- playback.df$EighthHhour*60*60 + playback.df$EighthHmin*60 + playback.df$EighthHsec
playback.df$Nineth_hatch_time_sec<- playback.df$NinethHhour*60*60 + playback.df$NinethHmin*60 + playback.df$NinethHsec
playback.df$Tenth_hatch_time_sec<- playback.df$TenthHhour*60*60 + playback.df$TenthHmin*60 + playback.df$TenthHsec
playback.df$Eleventh_hatch_time_sec<- playback.df$EleventhHhour*60*60 + playback.df$EleventhHmin*60 + playback.df$EleventhHsec
playback.df$Twelveth_hatch_time_sec<- playback.df$TwelvethHhour*60*60 + playback.df$TwelvethHmin*60 + playback.df$TwelvethHsec
playback.df$Thirteenth_hatch_time_sec<- playback.df$ThirteenthHhour*60*60 + playback.df$ThirteenthHmin*60 + playback.df$ThirteenthHsec
playback.df$Fourteenth_hatch_time_sec<- playback.df$FourteenthHhour*60*60 + playback.df$FourteenthHmin*60 + playback.df$FourteenthHsec
playback.df$Fifteenth_hatch_time_sec<- playback.df$FifteenthHhour*60*60 + playback.df$FifteenthHmin*60 + playback.df$FifteenthHsec

playback.df$First_latency_sec <- playback.df$First_hatch_time_sec - playback.df$Stimulus_start_sec
playback.df$Second_latency_sec <- playback.df$Second_hatch_time_sec - playback.df$Stimulus_start_sec
playback.df$Third_latency_sec <- playback.df$Third_hatch_time_sec - playback.df$Stimulus_start_sec
playback.df$Fourth_latency_sec <- playback.df$Fourth_hatch_time_sec - playback.df$Stimulus_start_sec
playback.df$Fifth_latency_sec <- playback.df$Fifth_hatch_time_sec - playback.df$Stimulus_start_sec
playback.df$Sixth_latency_sec <- playback.df$Sixth_hatch_time_sec - playback.df$Stimulus_start_sec
playback.df$Seventh_latency_sec <- playback.df$Seventh_hatch_time_sec - playback.df$Stimulus_start_sec
playback.df$Eighth_latency_sec <- playback.df$Eighth_hatch_time_sec - playback.df$Stimulus_start_sec
playback.df$Nineth_latency_sec <- playback.df$Nineth_hatch_time_sec - playback.df$Stimulus_start_sec
playback.df$Tenth_latency_sec <- playback.df$Tenth_hatch_time_sec - playback.df$Stimulus_start_sec
playback.df$Eleventh_latency_sec <- playback.df$Eleventh_hatch_time_sec - playback.df$Stimulus_start_sec
playback.df$Twelveth_latency_sec <- playback.df$Twelveth_hatch_time_sec - playback.df$Stimulus_start_sec
playback.df$Thirteenth_latency_sec <- playback.df$Thirteenth_hatch_time_sec - playback.df$Stimulus_start_sec
playback.df$Fourteenth_latency_sec <- playback.df$Fourteenth_hatch_time_sec - playback.df$Stimulus_start_sec
playback.df$Fifteenth_latency_sec <- playback.df$Fifteenth_hatch_time_sec - playback.df$Stimulus_start_sec
```

Tidy data in long format. To tidy, we need to gather the non-variable columns (hatching order). When gathering variables, we need to provide the name of the new key-value columns to create.The first argument is the name of the key column, which is the name of the variable defined by the values of the column headings (hatching order). The second argument is the name of the value column (hatching latency min). The third argment defines the columns to gather, here, every column except that named. 

```{r}
playback2 <- playback.df %>%
  unite(TrayID, c(Clutch, Tray), sep= "-", remove=FALSE) %>% #Combine Clutch and Tray into an individual tray ID for each tray tested
  select(Treatment, TrayID, Stage_average, First_latency_sec:Fifteenth_latency_sec, TestEggs) %>%
  gather(hatching.order, latencies_sec, First_latency_sec:Fifteenth_latency_sec, na.rm=TRUE) %>%
  #gsub("First", 1) %>%
  arrange(Treatment, TrayID) 

playback2$hatching.order <- gsub(".*First.*", 1, playback2$hatching.order)
playback2$hatching.order <- gsub(".*Second.*", 2, playback2$hatching.order)
playback2$hatching.order <- gsub(".*Third.*", 3, playback2$hatching.order)
playback2$hatching.order <- gsub(".*Fourth.*", 4, playback2$hatching.order)
playback2$hatching.order <- gsub(".*Fifth.*", 5, playback2$hatching.order)
playback2$hatching.order <- gsub(".*Sixth.*", 6, playback2$hatching.order)
playback2$hatching.order <- gsub(".*Seventh.*", 7, playback2$hatching.order)
playback2$hatching.order <- gsub(".*Eighth.*", 8, playback2$hatching.order)
playback2$hatching.order <- gsub(".*Nineth.*", 9, playback2$hatching.order)
playback2$hatching.order <- gsub(".*Tenth.*", 10, playback2$hatching.order)
playback2$hatching.order <- gsub(".*Eleventh.*", 11, playback2$hatching.order)
playback2$hatching.order <- gsub(".*Twelveth.*", 12, playback2$hatching.order)
playback2$hatching.order <- gsub(".*Thirteenth.*", 13, playback2$hatching.order)
playback2$hatching.order <- gsub(".*Fourteenth.*", 14, playback2$hatching.order)
playback2$hatching.order <- gsub(".*Fifteenth.*", 15, playback2$hatching.order)

playback2$hatching.order<-as.numeric(playback2$hatching.order)
playback2$PropH<-playback2$hatching.order/playback2$TestEggs

range(playback2$latencies_sec)
```

For each tray, add (0, 0) to the data.. such that at latency 0 seconds, 0 proportion of the tray had hatched. 
```{r}
playback3<- playback2 %>%
  group_by(Treatment, TrayID, TestEggs) %>%
  summarise(hatching.order=0) %>%
  mutate(latencies_sec=0, PropH=0) %>%
  bind_rows(playback2, .) %>%
  arrange(TrayID, hatching.order)
```

FInd the outlier that's decreasing propH with time between time 80 and 100 s and propH 0.75 about
```{r}
#temp<-subset(playback2, Treatment=="NT" & latencies_sec>100 & latencies_sec<200 & PropH >0.7 & PropH<0.75)

#temp<-subset(playback2, Treatment=="NT" & latencies_sec>80 & latencies_sec<110 & PropH >0.9)

#temp
```

Plot the hatching plot with x-axis as latency times (sec) and y axis as PropH.

```{r}
RdGy_pal <- brewer.pal("RdGy", n=11)
  
G_treated <- subset(playback3, playback3$Treatment=="G")
NT_untreated <- subset(playback3, playback3$Treatment=="NT")
```

```{r}
G_by_tray<- #62 G treated trays
  G_treated %>%
  group_by(TrayID) %>%
  summarize(num_tested = n())
kable(G_by_tray,digits=4)
```
```{r}
NT_by_tray<- #66 NT untreated trays
  NT_untreated %>%
  group_by(TrayID) %>%
  summarize(num_tested = n())
kable(NT_by_tray,digits=4)
```


```{r}
# hatching_plot <- ggplot(playback3, aes(x = latencies_sec, y = PropH, group=interaction(Treatment, TrayID), color=Treatment)) +
#   geom_line(data=G_treated, color="red") +
#   geom_line(data=NT_untreated, color="black") +
#   ##geom_point(data=G_treated, color="black", size=1) +
#   ##geom_smooth(data=G_treated, method = "lm", formula = y ~ poly(x, 2),  se=FALSE) +
#               #aes(color=RdGy_pal[1:62])) +
#   ##stat_smooth(aes(color=Treatment, group=TrayID), size=1, method="loess") +
#   ##stat_smooth(aes(group=TrayID), method = 'lm', formula = y ~ poly(x,2), se= FALSE) + #polynomial
#   #stat_smooth(method = 'nls', formula = y ~ a * log(x) +b, aes(colour = 'logarithmic'), se = FALSE, start = list(a=1,b=1)) +
#   ##stat_smooth(method = 'nls', formula = y ~ a*exp(b *x), aes(colour = 'Exponential'), se = FALSE, start = list(a=1,b=1))
#   scale_x_continuous(limits=c(0,350),
#                      breaks=c(0, 50, 100, 150, 200, 250, 300, 350),
#                      labels=c("0", "50", "100", "150","200", "250", "300", "350"))+
#   scale_y_continuous(limits = c(0, 1)) +
#   scale_color_manual(name=NULL,
#                     values=c(treatmentcolors[1], treatmentcolors[2]),
#                     labels=c("Treated", "Control")) +
#   labs(x = "Latency to hatch (sec)",
#        y = "Proportion of test eggs hatched\n") +
#   theme_cowplot(font_size = 12, line_size = 1) +
#   theme(axis.text.y=element_text(size=12, colour= "black")) +
#   theme(axis.text.x=element_text(size=12, colour= "black")) +
#   theme(axis.title.x=element_text(size=12, colour = "black")) +
#   theme(axis.title.y=element_text(size=12, colour = "black")) +
#   theme(legend.justification = c(1,0), legend.position = c(0.95,0.05)) 
# 
# hatching_plot
```


```{r}
hatching_plot_v2 <- ggplot(playback3, aes(x = latencies_sec, y = PropH, group=interaction(Treatment, TrayID), color=Treatment)) +
  geom_line(data=G_treated, color="lightcoral", size=0.5) +
  geom_line(data=NT_untreated, color="gray55", size=0.5) +
  geom_point(data=G_treated, color="lightcoral", size=0.5) +
  geom_point(data=NT_untreated, color="gray55", size=0.5) +
  scale_x_continuous(limits=c(0,350),
                     breaks=c(0, 50, 100, 150, 200, 250, 300, 350),
                     labels=c("0", "50", "100", "150","200", "250", "300", "350"))+
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(name=NULL,
                    values=c(treatmentcolors[1], treatmentcolors[2]),
                    labels=c("Treated", "Control")) +
  labs(x = "Latency to hatch (sec)",
       y = "Proportion of test eggs hatched\n") +
  theme_cowplot(font_size = 12, line_size = 1) +
  theme(axis.text.y=element_text(size=12, colour= "black")) +
  theme(axis.text.x=element_text(size=12, colour= "black")) +
  theme(axis.title.x=element_text(size=12, colour = "black")) +
  theme(axis.title.y=element_text(size=12, colour = "black")) +
  theme(legend.justification = c(1,0), legend.position = c(0.95,0.05)) 

hatching_plot_v2
```

```{r}
hatching_plot_v3 <- ggplot(playback3, aes(x = latencies_sec, y = PropH, group=interaction(Treatment, TrayID), color=Treatment)) +
  geom_line(data=G_treated, color="lightcoral", size=0.5) +
  geom_line(data=NT_untreated, color="gray55", size=0.5) +
  geom_point(data=G_treated, color="lightcoral", size=0.5) +
  geom_point(data=NT_untreated, color="gray55", size=0.5) +
  geom_smooth(data=playback2, aes(x = latencies_sec, y = PropH, group=Treatment), method = "glm", method.args=list(family="binomial")) +
  scale_x_continuous(limits=c(0,350),
                     breaks=c(0, 50, 100, 150, 200, 250, 300, 350),
                     labels=c("0", "50", "100", "150","200", "250", "300", "350"))+
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(name=NULL,
                    values=c(treatmentcolors[1], treatmentcolors[2]),
                    labels=c("Treated", "Control")) +
  labs(x = "Latency to hatch (sec)",
       y = "Proportion of test eggs hatched\n") +
  theme_cowplot(font_size = 12, line_size = 1) +
  theme(axis.text.y=element_text(size=12, colour= "black")) +
  theme(axis.text.x=element_text(size=12, colour= "black")) +
  theme(axis.title.x=element_text(size=12, colour = "black")) +
  theme(axis.title.y=element_text(size=12, colour = "black")) +
  theme(legend.justification = c(1,0), legend.position = c(0.95,0.05)) 

hatching_plot_v3
```

```{r}
treatmentcolors <- c('red', 'black')

hatching_plot_v4 <- ggplot(playback3, aes(x = latencies_sec, y = PropH, color=Treatment)) +
  geom_point(data=G_treated, color="red", size=0.5) +
  geom_point(data=NT_untreated, color="black", size=0.5) +
  geom_smooth(method = "glm", method.args=list(family="binomial")) +
  scale_x_continuous(limits=c(0,350),
                     breaks=c(0, 50, 100, 150, 200, 250, 300, 350),
                     labels=c("0", "50", "100", "150","200", "250", "300", "350"))+
  scale_y_continuous(limits = c(0, 1)) +
  scale_color_manual(name=NULL,
                    values=c(treatmentcolors[1], treatmentcolors[2]),
                    labels=c("Treated", "Control")) +
  labs(x = "\nLatency to hatch (sec)",
       y = "Proportion of test eggs hatched\n") +
  theme_cowplot(font_size = 12, line_size = 1) +
  theme(axis.text.y=element_text(size=12, colour= "black")) +
  theme(axis.text.x=element_text(size=12, colour= "black")) +
  theme(axis.title.x=element_text(size=12, colour = "black")) +
  theme(axis.title.y=element_text(size=12, colour = "black")) +
  theme(legend.justification = c(1,0), legend.position = c(0.95,0.05)) 

hatching_plot_v4
```

Save figure
```{r}
ggsave("~/Desktop/Figure7v1.pdf",
       plot = hatching_plot_v4, 
       width = 15, height = 10,
       units = "cm", 
       dpi = 300, 
       useDingbats=FALSE)

```

Now we want to look at latency to hatch of all tested embryos that hatched: 

By 5 days of age, there is no significant difference in the latency to hatch of all tested embryos that hatched (GLMM, χ2=1.0805, df=1, P=0.2986, Fig. 7) between gentamicin treated and untreated control individuals.

```{r}
range(playback2$latencies_sec)

glmm0 <- glmer(latencies_sec ~ 1 + (1|TrayID), family=Gamma(inverse),data=playback2,  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
glmm1 <- glmer(latencies_sec ~ Treatment + (1|TrayID), family=Gamma(inverse), data=playback2, glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
glmm2 <- glmer(latencies_sec ~ Stage_average + (1|TrayID), family=Gamma(inverse), data=playback2, glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
glmm3 <- glmer(latencies_sec ~ Treatment + Stage_average + (1|TrayID), family=Gamma(inverse), data=playback2, glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
glmm4 <- glmer(latencies_sec ~ Treatment * Stage_average + (1|TrayID), family=Gamma(inverse), data=playback2, glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))

anova(glmm1, glmm3) # No stage effect
anova(glmm2, glmm3) # No treatment effect **
anova(glmm3, glmm4) # No interaction effect
```

# TREATMENT EFFECT ON VOR

### VOR figure

```{r}
NT <- subset(all_data, all_data$Treatment == "NT")
GT <- subset(all_data, all_data$Treatment == "G")
```

```{r}
Figure_VOR<-ggplot(data=all_data, aes(x=Treatment, y=Mean_VOR, color=Treatment)) + 
  geom_boxplot(alpha = 1, size = 1, width = 0.15, outlier.shape=NA) +
  geom_jitter(data=NT, aes(x=Treatment, y=Mean_VOR), colour="black", pch=16, size=2, position=position_jitter(width=0.05)) +
  geom_jitter(data=GT, aes(x=Treatment, y=Mean_VOR), colour="red", pch=16, size=2,  position=position_jitter(width=0.05)) +
  scale_x_continuous(limits=c(26.5, 33.5),
                     breaks=c(27, 28, 29, 30, 31, 32, 33),
                     labels=c("27", "28", "29", "30", "31", "32", "33"))+
  scale_y_continuous(limits=c(0, 80),
                     breaks=c(0, 25, 50, 75),
                     labels=c("0", "25", "50", "75"))+
  scale_x_discrete(labels=c("Treated", "Control")) +
  labs(x = NULL,
       y = "VOR (degrees) \n") +
  scale_color_manual(name=NULL, 
                     values=c(treatmentcolors[1], treatmentcolors[2]),
                     labels=c("Treated", "Control")) +
  theme_cowplot(font_size = 12, line_size = 1) +
  theme(axis.text.y=element_text(size=12, colour= "black")) +
  theme(axis.text.x=element_text(size=12, colour= "black")) +
  theme(axis.title.x=element_text(size=12, colour = "black")) +
  theme(axis.title.y=element_text(size=12, colour = "black")) +
  theme(legend.position = "none")

Figure_VOR
```

```{r}
ggsave("~/Desktop/VOR_fig_v1.pdf",
plot = Figure_VOR, # or give ggplot object name as in myPlot,
width = 24, height = 14,
units = "cm", # other options c("in", "cm", "mm"),
dpi = 300)
dev.off()
```

For combined data (including all hatchlings where we measured VOR in both the individual experiment and playback experiment), we tested for a treatment effect on VOR. 

```{r}
glmm1<-glmer(Mean_VOR ~ 1 + (1|Clutch), family=Gamma(inverse), data=all_data)
glmm2<-glmer(Mean_VOR ~ Combined_stage + (1|Clutch), family=Gamma(inverse), data=all_data)
glmm3<-glmer(Mean_VOR ~ Treatment + (1|Clutch), family=Gamma(inverse), data=all_data)
glmm4<-glmer(Mean_VOR ~ Combined_stage + Treatment + (1|Clutch), family=Gamma(inverse), data=all_data)
glmm5<-glmer(Mean_VOR ~ Combined_stage * Treatment + (1|Clutch), family=Gamma(inverse), data=all_data)

anova(glmm2, glmm4) #Treatment effect
anova(glmm3, glmm4) #Stage effect
anova(glmm4, glmm5) #interaction 
```

```{r}
#treatmentcolors <- c('red', 'black')

Figure_stage_VOR<-ggplot(data=all_data, aes(x=Combined_stage, y=Mean_VOR, color=Treatment)) + 
  geom_point(data=NT, aes(x=Combined_stage, y=Mean_VOR), colour="black", pch=16, size=2,position=position_jitter(width=0.25, height=2)) +
  geom_point(data=GT, aes(x=Combined_stage, y=Mean_VOR), colour="red", pch=16, size=2, position=position_jitter(width=0.25, height=2)) +
  scale_x_continuous(limits=c(26.75, 33.25),
                     breaks=c(27, 28, 29, 30, 31, 32, 33),
                     labels=c("27", "28", "29", "30", "31", "32", "33"))+
  scale_y_continuous(limits=c(0, 75),
                     breaks=c(0, 25, 50, 75),
                     labels=c("0", "25", "50", "75"))+
  #scale_x_discrete(labels=c("Treated", "Control")) +
  labs(x = "\nDevelopmental stage", 
       y = "VOR amplitude (deg)\n") +
  scale_color_manual(name=NULL, 
                     values=c(treatmentcolors[1], treatmentcolors[2]),
                     labels=c("Gentamicin", "Control")) +
  theme_cowplot(font_size = 12, line_size = 1, font_family="Helvetica") +
  theme(axis.text.y=element_text(size=12, colour= "black")) +
  theme(axis.text.x=element_text(size=12, colour= "black")) +
  theme(axis.title.x=element_text(size=12, colour = "black")) +
  theme(axis.title.y=element_text(size=12, colour = "black")) +
  theme(legend.position = "none")

Figure_stage_VOR
```

```{r}
ggsave("~/Desktop/VOR_fig_stage_v1.pdf",
       plot = Figure_stage_VOR, 
       width = 15, height = 10,
       units = "cm", 
       dpi = 300, 
       useDingbats=FALSE)

```

Tested for a treatment effect on VOR in a subset of older hatchlings (stage 29 and up)

```{r}
older <- subset(all_data, Combined_stage >= 29)
```

```{r}
glmm1<-glmer(Mean_VOR ~ 1 + (1|Clutch), family=Gamma(inverse), data=older)
glmm2<-glmer(Mean_VOR ~ Combined_stage + (1|Clutch), family=Gamma(inverse), data=older)
glmm3<-glmer(Mean_VOR ~ Treatment + (1|Clutch), family=Gamma(inverse), data=older)
glmm4<-glmer(Mean_VOR ~ Combined_stage + Treatment + (1|Clutch), family=Gamma(inverse), data=older)
glmm5<-glmer(Mean_VOR ~ Combined_stage * Treatment + (1|Clutch), family=Gamma(inverse), data=older)

anova(glmm2, glmm4) #Treatment effect
anova(glmm3, glmm4) #Stage effect
anova(glmm4, glmm5) #interaction 
```

```{r}
VOR_by_treatment<-
  all_data %>%
  group_by(Treatment) %>%
  summarize(count = n(),
            avg_VOR = mean(Mean_VOR, na.rm=T),
            SE = sd(Mean_VOR, na.rm=T)/sqrt(n())
            )
kable(VOR_by_treatment,digits=4)

VOR_by_stage_treatment<-
  all_data %>%
  group_by(Combined_stage, Treatment) %>%
  summarize(count = n(),
            avg_VOR = mean(Mean_VOR, na.rm=T),
            SE = sd(Mean_VOR, na.rm=T)/sqrt(n())
            )
kable(VOR_by_stage_treatment,digits=4)
```


# Pairs only 

Subset only paired data (clutches where we have BOTH NT and G trays / or / individuals). 
AND data where mean stage between treatments is within 1 stage. (to account for stage differences)
siblings within 1 stage of each other. 
```{r}
Paired_data_similar_stages <-
  all_data %>%
  filter(!is.na(Sample_name)) %>%
  group_by(Clutch, Treatment) %>%
  summarize(num_tested = n(), 
            mean_amp = mean(Mean_VOR, na.rm=T),
            mean_stage = mean(Combined_stage, na.rm=T)
            )%>%
  mutate(count=n()) %>%
  filter(count==2) %>%
  mutate(Difference = mean_stage - lag(mean_stage)) %>%
  #also filter out the pairs where the mean stage between treatments is really different (>1) 
  mutate(Difference_new = ave(Difference, Clutch, FUN=function(x)unique(x[!is.na(x)]))) %>%#fill in lag so that both indivs have difference value. 
  filter(Difference_new > -1 && Difference_new < 1)

kable(Paired_data_similar_stages,digits=4)

nrow(Paired_data_similar_stages)/2
```

Across these paired data, is there a treatment effect on VOR? 

```{r, warning=FALSE}
glmm1<-glmer(mean_amp ~ 1 + (1|Clutch), family=Gamma(inverse), data=Paired_data_similar_stages)
glmm2<-glmer(mean_amp ~ mean_stage + (1|Clutch), family=Gamma(inverse), data=Paired_data_similar_stages)
glmm3<-glmer(mean_amp ~ Treatment + (1|Clutch), family=Gamma(inverse), data=Paired_data_similar_stages)
glmm4<-glmer(mean_amp ~ mean_stage + Treatment + (1|Clutch), family=Gamma(inverse), data=Paired_data_similar_stages)
glmm5<-glmer(mean_amp ~ mean_stage * Treatment + (1|Clutch), family=Gamma(inverse), data=Paired_data_similar_stages)

anova(glmm2, glmm4) #Treatment effect NONE
anova(glmm3, glmm4) #Stage effect
anova(glmm4, glmm5) #interaction 
```

```{r}
NT_paired<-subset(Paired_data_similar_stages, Paired_data_similar_stages$Treatment=="NT")
GT_paired<-subset(Paired_data_similar_stages, Paired_data_similar_stages$Treatment=="G")

Figure_stage_VOR_paired<-ggplot(data=Paired_data_similar_stages, aes(x=mean_stage, y=mean_amp, color=Treatment)) + 
  geom_point(data=NT_paired, aes(x=mean_stage, y=mean_amp), colour="black", pch=16, size=2,position=position_jitter(width=0.25)) +
  geom_point(data=GT_paired, aes(x=mean_stage, y=mean_amp), colour="red", pch=16, size=2, position=position_jitter(width=0.25)) +
  scale_x_continuous(limits=c(26.75, 33.25),
                     breaks=c(27, 28, 29, 30, 31, 32, 33),
                     labels=c("27", "28", "29", "30", "31", "32", "33"))+
  scale_y_continuous(limits=c(0, 60),
                     breaks=c(0, 20, 40, 60),
                     labels=c("0", "20", "40", "60"))+
  labs(x = "Developmental stage", 
       y = "VOR amplitude (deg)") +
  scale_color_manual(name=NULL, 
                     values=c(treatmentcolors[1], treatmentcolors[2]),
                     labels=c("Gentamicin", "Control")) +
  theme_cowplot(font_size = 12, line_size = 1, font_family="Helvetica") +
  theme(axis.text.y=element_text(size=12, colour= "black")) +
  theme(axis.text.x=element_text(size=12, colour= "black")) +
  theme(axis.title.x=element_text(size=12, colour = "black")) +
  theme(axis.title.y=element_text(size=12, colour = "black")) +
  theme(legend.position = "none")

Figure_stage_VOR_paired
```

```{r}
ggsave("~/Desktop/VOR_fig_stage_v1.pdf",
       plot = Figure_stage_VOR, 
       width = 15, height = 10,
       units = "cm", 
       dpi = 300, 
       useDingbats=FALSE)
```
